<!doctype html>
<html lang="es" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Control de Asistencia - San Ignacio</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, updateDoc, deleteDoc, doc, query, where, orderBy } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-analytics.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDjkCjj1iLMi3Z22o6cj1Xa-yYDoqjBm04",
            authDomain: "base-de-datos-san-ignacio.firebaseapp.com",
            projectId: "base-de-datos-san-ignacio",
            storageBucket: "base-de-datos-san-ignacio.firebasestorage.app",
            messagingSenderId: "698408506523",
            appId: "1:698408506523:web:ede2c739a1920e8956a23e",
            measurementId: "G-Z16V5DDNB8"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const analytics = getAnalytics(app);

        // Make Firebase available globally
        window.firebaseDb = db;
        window.firebaseApp = app;
    </script>
  <style>
        body {
            box-sizing: border-box;
        }
        .loading-spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            padding: 12px 24px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }
        .toast.show {
            transform: translateX(0);
        }
        .toast.success {
            background-color: #10b981;
        }
        .toast.error {
            background-color: #ef4444;
        }
    </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
 </head>
 <body class="h-full bg-gradient-to-br from-blue-50 to-indigo-100 font-sans"><!-- Login Screen -->
  <div id="loginScreen" class="min-h-full flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8">
   <div class="max-w-md w-full space-y-8">
    <div class="text-center">
     <div class="mx-auto h-16 w-16 bg-blue-600 rounded-full flex items-center justify-center mb-4">
      <svg class="h-8 w-8 text-white" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"></path>
      </svg>
     </div>
     <h2 id="schoolName" class="text-3xl font-bold text-gray-900">Colegio San Ignacio de Loyola</h2>
     <p id="welcomeMessage" class="mt-2 text-lg text-gray-600">Sistema de Control de Asistencia</p>
    </div>
    <div class="bg-white rounded-lg shadow-lg p-8">
     <h3 id="loginTitle" class="text-xl font-semibold text-gray-900 mb-6 text-center">Iniciar Sesión</h3>
     <form id="loginForm" class="space-y-6">
      <div><label for="userType" class="block text-sm font-medium text-gray-700 mb-2">Tipo de Usuario</label> <select id="userType" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"> <option value="admin">Administrador</option> <option value="docente">Docente</option> </select>
      </div>
      <div><label for="username" class="block text-sm font-medium text-gray-700 mb-2">Usuario</label> <input type="text" id="username" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Ingrese su usuario" required>
      </div>
      <div><label for="password" class="block text-sm font-medium text-gray-700 mb-2">Contraseña</label> <input type="password" id="password" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Ingrese su contraseña" required>
      </div><button type="submit" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-200 font-medium"> Ingresar </button>
     </form>
    </div>
   </div>
  </div><!-- Main App Screen -->
  <div id="mainApp" class="hidden min-h-full"><!-- Header -->
   <header class="bg-white shadow-sm border-b border-gray-200">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
     <div class="flex justify-between items-center py-4">
      <div class="flex items-center">
       <div class="h-10 w-10 bg-blue-600 rounded-full flex items-center justify-center mr-3">
        <svg class="h-6 w-6 text-white" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
        </svg>
       </div>
       <div>
        <h1 class="text-xl font-semibold text-gray-900">Control de Asistencia</h1>
        <p class="text-sm text-gray-500" id="currentDate"></p>
       </div>
      </div>
      <div class="flex items-center space-x-4"><span class="text-sm text-gray-600" id="userInfo"></span> <button id="logoutBtn" class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700 transition duration-200 text-sm font-medium"> Cerrar Sesión </button>
      </div>
     </div>
    </div>
   </header><!-- Main Content -->
   <main class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8"><!-- Quick Registration Form -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
     <h2 class="text-lg font-semibold text-gray-900 mb-4">Registro Rápido de Asistencia</h2>
     <form id="attendanceForm" class="grid grid-cols-1 md:grid-cols-6 gap-4">
      <div><label for="grado" class="block text-sm font-medium text-gray-700 mb-1">Grado</label> <select id="grado" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required> <option value="">Seleccionar</option> <option value="7°">7° Grado</option> <option value="8°">8° Grado</option> <option value="9°">9° Grado</option> <option value="10°">10° Grado</option> <option value="11°">11° Grado</option> </select>
      </div>
      <div><label for="seccion" class="block text-sm font-medium text-gray-700 mb-1">Sección</label> <select id="seccion" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required> <option value="">Seleccionar</option> <option value="A">Sección A</option> <option value="B">Sección B</option> <option value="C">Sección C</option> </select>
      </div>
      <div><label for="totalVarones" class="block text-sm font-medium text-gray-700 mb-1">Presentes Varones</label> <input type="number" id="totalVarones" min="0" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
      </div>
      <div><label for="totalMujeres" class="block text-sm font-medium text-gray-700 mb-1">Presentes Mujeres</label> <input type="number" id="totalMujeres" min="0" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
      </div>
      <div><label for="ausentesVarones" class="block text-sm font-medium text-gray-700 mb-1">Ausentes Varones</label> <input type="number" id="ausentesVarones" min="0" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
      </div>
      <div><label for="ausentesMujeres" class="block text-sm font-medium text-gray-700 mb-1">Ausentes Mujeres</label> <input type="number" id="ausentesMujeres" min="0" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
      </div>
      <div class="flex items-end"><button type="submit" id="submitBtn" class="w-full bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 transition duration-200 font-medium flex items-center justify-center"> <span id="submitText">Registrar</span>
        <div id="submitSpinner" class="loading-spinner ml-2 hidden"></div></button>
      </div>
     </form>
    </div><!-- Filters and Actions -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
     <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center space-y-4 sm:space-y-0">
      <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-4">
       <div><label for="filterGrado" class="block text-sm font-medium text-gray-700 mb-1">Filtrar por Grado</label> <select id="filterGrado" class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"> <option value="">Todos los grados</option> <option value="7°">7° Grado</option> <option value="8°">8° Grado</option> <option value="9°">9° Grado</option> <option value="10°">10° Grado</option> <option value="11°">11° Grado</option> </select>
       </div>
       <div><label for="filterSeccion" class="block text-sm font-medium text-gray-700 mb-1">Filtrar por Sección</label> <select id="filterSeccion" class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"> <option value="">Todas las secciones</option> <option value="A">Sección A</option> <option value="B">Sección B</option> <option value="C">Sección C</option> </select>
       </div>
      </div>
      <div class="flex space-x-2"><button id="downloadPDF" class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700 transition duration-200 text-sm font-medium flex items-center">
        <svg class="h-4 w-4 mr-2" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
        </svg> PDF </button> <button id="downloadCSV" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 transition duration-200 text-sm font-medium flex items-center">
        <svg class="h-4 w-4 mr-2" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
        </svg> CSV </button>
      </div>
     </div>
    </div><!-- Attendance Records Table -->
    <div class="bg-white rounded-lg shadow-md overflow-hidden">
     <div class="px-6 py-4 border-b border-gray-200">
      <h3 class="text-lg font-semibold text-gray-900">Registros de Asistencia del Día</h3>
      <p class="text-sm text-gray-600 mt-1">Total de registros: <span id="recordCount">0</span></p>
     </div>
     <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-gray-200">
       <thead class="bg-gray-50">
        <tr>
         <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Grado</th>
         <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Sección</th>
         <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Presentes V</th>
         <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Presentes M</th>
         <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ausentes V</th>
         <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ausentes M</th>
         <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total</th>
         <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Docente</th>
         <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Hora</th>
         <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
        </tr>
       </thead>
       <tbody id="attendanceTableBody" class="bg-white divide-y divide-gray-200"><!-- Records will be populated here -->
       </tbody>
      </table>
     </div>
     <div id="emptyState" class="hidden text-center py-12">
      <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
      </svg>
      <h3 class="mt-2 text-sm font-medium text-gray-900">No hay registros</h3>
      <p class="mt-1 text-sm text-gray-500">Comience registrando la asistencia de una clase.</p>
     </div>
    </div>
   </main>
  </div><!-- Edit Modal -->
  <div id="editModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
   <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
    <div class="mt-3">
     <h3 class="text-lg font-medium text-gray-900 mb-4">Editar Registro</h3>
     <form id="editForm" class="space-y-4">
      <div><label for="editGrado" class="block text-sm font-medium text-gray-700 mb-1">Grado</label> <select id="editGrado" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required> <option value="7°">7° Grado</option> <option value="8°">8° Grado</option> <option value="9°">9° Grado</option> <option value="10°">10° Grado</option> <option value="11°">11° Grado</option> </select>
      </div>
      <div><label for="editSeccion" class="block text-sm font-medium text-gray-700 mb-1">Sección</label> <select id="editSeccion" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required> <option value="A">Sección A</option> <option value="B">Sección B</option> <option value="C">Sección C</option> </select>
      </div>
      <div><label for="editVarones" class="block text-sm font-medium text-gray-700 mb-1">Presentes Varones</label> <input type="number" id="editVarones" min="0" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
      </div>
      <div><label for="editMujeres" class="block text-sm font-medium text-gray-700 mb-1">Presentes Mujeres</label> <input type="number" id="editMujeres" min="0" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
      </div>
      <div><label for="editAusentesVarones" class="block text-sm font-medium text-gray-700 mb-1">Ausentes Varones</label> <input type="number" id="editAusentesVarones" min="0" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
      </div>
      <div><label for="editAusentesMujeres" class="block text-sm font-medium text-gray-700 mb-1">Ausentes Mujeres</label> <input type="number" id="editAusentesMujeres" min="0" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
      </div>
      <div class="flex justify-end space-x-3 pt-4"><button type="button" id="cancelEdit" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400 transition duration-200"> Cancelar </button> <button type="submit" id="saveEdit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition duration-200 flex items-center"> <span id="saveEditText">Guardar</span>
        <div id="saveEditSpinner" class="loading-spinner ml-2 hidden"></div></button>
      </div>
     </form>
    </div>
   </div>
  </div><!-- Delete Confirmation Modal -->
  <div id="deleteModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
   <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
    <div class="mt-3 text-center">
     <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4">
      <svg class="h-6 w-6 text-red-600" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
      </svg>
     </div>
     <h3 class="text-lg font-medium text-gray-900 mb-2">Confirmar Eliminación</h3>
     <p class="text-sm text-gray-500 mb-6">¿Está seguro que desea eliminar este registro? Esta acción no se puede deshacer.</p>
     <div class="flex justify-center space-x-3"><button id="cancelDelete" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400 transition duration-200"> Cancelar </button> <button id="confirmDelete" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition duration-200 flex items-center"> <span id="deleteText">Eliminar</span>
       <div id="deleteSpinner" class="loading-spinner ml-2 hidden"></div></button>
     </div>
    </div>
   </div>
  </div>
  <script>
        // Global variables
        let currentUser = null;
        let attendanceRecords = [];
        let editingRecord = null;
        let deletingRecord = null;
        let recordCount = 0;

        // Default configuration
        const defaultConfig = {
            school_name: "Colegio San Ignacio de Loyola",
            welcome_message: "Sistema de Control de Asistencia",
            login_title: "Iniciar Sesión"
        };

        // Initialize app
        async function initializeApp() {
            if (window.elementSdk) {
                await window.elementSdk.init({
                    defaultConfig,
                    onConfigChange: async (config) => {
                        document.getElementById('schoolName').textContent = config.school_name || defaultConfig.school_name;
                        document.getElementById('welcomeMessage').textContent = config.welcome_message || defaultConfig.welcome_message;
                        document.getElementById('loginTitle').textContent = config.login_title || defaultConfig.login_title;
                    },
                    mapToCapabilities: (config) => ({
                        recolorables: [],
                        borderables: [],
                        fontEditable: undefined,
                        fontSizeable: undefined
                    }),
                    mapToEditPanelValues: (config) => new Map([
                        ["school_name", config.school_name || defaultConfig.school_name],
                        ["welcome_message", config.welcome_message || defaultConfig.welcome_message],
                        ["login_title", config.login_title || defaultConfig.login_title]
                    ])
                });
            }

            setupEventListeners();
            updateCurrentDate();
            await loadAttendanceRecords();
        }

        // Firebase functions
        async function loadAttendanceRecords() {
            try {
                const { collection, getDocs, query, orderBy } = await import("https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js");
                const q = query(collection(window.firebaseDb, "attendance"), orderBy("timestamp", "desc"));
                const querySnapshot = await getDocs(q);
                
                attendanceRecords = [];
                querySnapshot.forEach((doc) => {
                    attendanceRecords.push({ id: doc.id, ...doc.data() });
                });
                
                recordCount = attendanceRecords.length;
                renderAttendanceTable();
                updateRecordCount();
            } catch (error) {
                console.error("Error loading records:", error);
                showToast('Error al cargar los registros', 'error');
            }
        }

        async function saveAttendanceRecord(record) {
            try {
                const { collection, addDoc } = await import("https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js");
                await addDoc(collection(window.firebaseDb, "attendance"), record);
                await loadAttendanceRecords();
                return true;
            } catch (error) {
                console.error("Error saving record:", error);
                return false;
            }
        }

        async function updateAttendanceRecord(recordId, updatedData) {
            try {
                const { doc, updateDoc } = await import("https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js");
                const recordRef = doc(window.firebaseDb, "attendance", recordId);
                await updateDoc(recordRef, updatedData);
                await loadAttendanceRecords();
                return true;
            } catch (error) {
                console.error("Error updating record:", error);
                return false;
            }
        }

        async function deleteAttendanceRecord(recordId) {
            try {
                const { doc, deleteDoc } = await import("https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js");
                await deleteDoc(doc(window.firebaseDb, "attendance", recordId));
                await loadAttendanceRecords();
                return true;
            } catch (error) {
                console.error("Error deleting record:", error);
                return false;
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            // Login form
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            
            // Attendance form
            document.getElementById('attendanceForm').addEventListener('submit', handleAttendanceSubmit);
            
            // Filters
            document.getElementById('filterGrado').addEventListener('change', renderAttendanceTable);
            document.getElementById('filterSeccion').addEventListener('change', renderAttendanceTable);
            
            // Download buttons
            document.getElementById('downloadPDF').addEventListener('click', downloadPDF);
            document.getElementById('downloadCSV').addEventListener('click', downloadCSV);
            
            // Logout
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);
            
            // Edit modal
            document.getElementById('editForm').addEventListener('submit', handleEditSubmit);
            document.getElementById('cancelEdit').addEventListener('click', closeEditModal);
            
            // Delete modal
            document.getElementById('confirmDelete').addEventListener('click', handleDeleteConfirm);
            document.getElementById('cancelDelete').addEventListener('click', closeDeleteModal);
        }

        // Handle login
        function handleLogin(e) {
            e.preventDefault();
            
            const userType = document.getElementById('userType').value;
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            // Simple authentication (in real app, this would be server-side)
            if ((userType === 'admin' && username === 'admin' && password === 'admin123') ||
                (userType === 'docente' && username === 'Roberto Rivas' && password === 'docente123')) {
                
                currentUser = {
                    type: userType,
                    username: username
                };
                
                showMainApp();
                showToast('Inicio de sesión exitoso', 'success');
            } else {
                showToast('Usuario o contraseña incorrectos', 'error');
            }
        }

        // Show main app
        function showMainApp() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            
            const userInfo = document.getElementById('userInfo');
            userInfo.textContent = `${currentUser.type === 'admin' ? 'Administrador' : 'Docente'}: ${currentUser.username}`;
        }

        // Handle logout
        function handleLogout() {
            currentUser = null;
            document.getElementById('mainApp').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('loginForm').reset();
            showToast('Sesión cerrada correctamente', 'success');
        }

        // Handle attendance form submission
        async function handleAttendanceSubmit(e) {
            e.preventDefault();
            
            const submitBtn = document.getElementById('submitBtn');
            const submitText = document.getElementById('submitText');
            const submitSpinner = document.getElementById('submitSpinner');
            
            // Show loading state
            submitBtn.disabled = true;
            submitText.textContent = 'Registrando...';
            submitSpinner.classList.remove('hidden');
            
            const grado = document.getElementById('grado').value;
            const seccion = document.getElementById('seccion').value;
            const totalVarones = parseInt(document.getElementById('totalVarones').value);
            const totalMujeres = parseInt(document.getElementById('totalMujeres').value);
            const ausentesVarones = parseInt(document.getElementById('ausentesVarones').value);
            const ausentesMujeres = parseInt(document.getElementById('ausentesMujeres').value);
            
            const now = new Date();
            const record = {
                fecha: now.toISOString().split('T')[0],
                grado: grado,
                seccion: seccion,
                total_varones: totalVarones,
                total_mujeres: totalMujeres,
                ausentes_varones: ausentesVarones,
                ausentes_mujeres: ausentesMujeres,
                docente: currentUser.username,
                timestamp: now.getTime()
            };
            
            const success = await saveAttendanceRecord(record);
            
            if (success) {
                showToast('Asistencia registrada correctamente', 'success');
                document.getElementById('attendanceForm').reset();
            } else {
                showToast('Error al registrar la asistencia', 'error');
            }
            
            // Reset loading state
            submitBtn.disabled = false;
            submitText.textContent = 'Registrar';
            submitSpinner.classList.add('hidden');
        }

        // Render attendance table
        function renderAttendanceTable() {
            const tbody = document.getElementById('attendanceTableBody');
            const emptyState = document.getElementById('emptyState');
            const filterGrado = document.getElementById('filterGrado').value;
            const filterSeccion = document.getElementById('filterSeccion').value;
            
            // Filter records
            let filteredRecords = attendanceRecords.filter(record => {
                const today = new Date().toISOString().split('T')[0];
                return record.fecha === today;
            });
            
            if (filterGrado) {
                filteredRecords = filteredRecords.filter(record => record.grado === filterGrado);
            }
            
            if (filterSeccion) {
                filteredRecords = filteredRecords.filter(record => record.seccion === filterSeccion);
            }
            
            // Sort by timestamp (newest first)
            filteredRecords.sort((a, b) => b.timestamp - a.timestamp);
            
            if (filteredRecords.length === 0) {
                tbody.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }
            
            emptyState.classList.add('hidden');
            
            tbody.innerHTML = filteredRecords.map(record => {
                const time = new Date(record.timestamp).toLocaleTimeString('es-ES', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                const totalPresentes = record.total_varones + record.total_mujeres;
                const totalAusentes = (record.ausentes_varones || 0) + (record.ausentes_mujeres || 0);
                const totalGeneral = totalPresentes + totalAusentes;
                
                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${record.grado}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${record.seccion}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-green-600 font-medium">${record.total_varones}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-green-600 font-medium">${record.total_mujeres}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-red-600 font-medium">${record.ausentes_varones || 0}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-red-600 font-medium">${record.ausentes_mujeres || 0}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                            <div class="flex flex-col">
                                <span class="text-green-600">${totalPresentes} presentes</span>
                                <span class="text-red-600 text-xs">${totalAusentes} ausentes</span>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${record.docente}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${time}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button onclick="openEditModal('${record.__backendId}')" class="text-blue-600 hover:text-blue-900 mr-3">
                                <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                </svg>
                            </button>
                            <button onclick="openDeleteModal('${record.__backendId}')" class="text-red-600 hover:text-red-900">
                                <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                </svg>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Open edit modal
        function openEditModal(recordId) {
            const record = attendanceRecords.find(r => r.id === recordId);
            if (!record) return;
            
            editingRecord = record;
            
            document.getElementById('editGrado').value = record.grado;
            document.getElementById('editSeccion').value = record.seccion;
            document.getElementById('editVarones').value = record.total_varones;
            document.getElementById('editMujeres').value = record.total_mujeres;
            document.getElementById('editAusentesVarones').value = record.ausentes_varones || 0;
            document.getElementById('editAusentesMujeres').value = record.ausentes_mujeres || 0;
            
            document.getElementById('editModal').classList.remove('hidden');
        }

        // Close edit modal
        function closeEditModal() {
            document.getElementById('editModal').classList.add('hidden');
            editingRecord = null;
        }

        // Handle edit form submission
        async function handleEditSubmit(e) {
            e.preventDefault();
            
            if (!editingRecord) return;
            
            const saveBtn = document.getElementById('saveEdit');
            const saveText = document.getElementById('saveEditText');
            const saveSpinner = document.getElementById('saveEditSpinner');
            
            // Show loading state
            saveBtn.disabled = true;
            saveText.textContent = 'Guardando...';
            saveSpinner.classList.remove('hidden');
            
            const updatedData = {
                grado: document.getElementById('editGrado').value,
                seccion: document.getElementById('editSeccion').value,
                total_varones: parseInt(document.getElementById('editVarones').value),
                total_mujeres: parseInt(document.getElementById('editMujeres').value),
                ausentes_varones: parseInt(document.getElementById('editAusentesVarones').value),
                ausentes_mujeres: parseInt(document.getElementById('editAusentesMujeres').value)
            };
            
            const success = await updateAttendanceRecord(editingRecord.id, updatedData);
            
            if (success) {
                showToast('Registro actualizado correctamente', 'success');
                closeEditModal();
            } else {
                showToast('Error al actualizar el registro', 'error');
            }
            
            // Reset loading state
            saveBtn.disabled = false;
            saveText.textContent = 'Guardar';
            saveSpinner.classList.add('hidden');
        }

        // Open delete modal
        function openDeleteModal(recordId) {
            const record = attendanceRecords.find(r => r.id === recordId);
            if (!record) return;
            
            deletingRecord = record;
            document.getElementById('deleteModal').classList.remove('hidden');
        }

        // Close delete modal
        function closeDeleteModal() {
            document.getElementById('deleteModal').classList.add('hidden');
            deletingRecord = null;
        }

        // Handle delete confirmation
        async function handleDeleteConfirm() {
            if (!deletingRecord) return;
            
            const deleteBtn = document.getElementById('confirmDelete');
            const deleteText = document.getElementById('deleteText');
            const deleteSpinner = document.getElementById('deleteSpinner');
            
            // Show loading state
            deleteBtn.disabled = true;
            deleteText.textContent = 'Eliminando...';
            deleteSpinner.classList.remove('hidden');
            
            const success = await deleteAttendanceRecord(deletingRecord.id);
            
            if (success) {
                showToast('Registro eliminado correctamente', 'success');
                closeDeleteModal();
            } else {
                showToast('Error al eliminar el registro', 'error');
            }
            
            // Reset loading state
            deleteBtn.disabled = false;
            deleteText.textContent = 'Eliminar';
            deleteSpinner.classList.add('hidden');
        }

        // Update record count
        function updateRecordCount() {
            document.getElementById('recordCount').textContent = recordCount;
        }

        // Update current date
        function updateCurrentDate() {
            const now = new Date();
            const dateStr = now.toLocaleDateString('es-ES', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            document.getElementById('currentDate').textContent = dateStr;
        }

        // Download PDF report
        function downloadPDF() {
            const today = new Date().toISOString().split('T')[0];
            const todayRecords = attendanceRecords.filter(record => record.fecha === today);
            
            if (todayRecords.length === 0) {
                showToast('No hay registros para descargar', 'error');
                return;
            }
            
            // Create PDF content
            let pdfContent = `REPORTE DE ASISTENCIA DIARIA\n`;
            pdfContent += `Colegio San Ignacio de Loyola\n`;
            pdfContent += `Fecha: ${new Date().toLocaleDateString('es-ES')}\n\n`;
            pdfContent += `GRADO\tSECCIÓN\tPRES.V\tPRES.M\tAUS.V\tAUS.M\tTOTAL PRES.\tTOTAL AUS.\tDOCENTE\tHORA\n`;
            pdfContent += `${'='.repeat(120)}\n`;
            
            todayRecords.forEach(record => {
                const time = new Date(record.timestamp).toLocaleTimeString('es-ES', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
                const totalPresentes = record.total_varones + record.total_mujeres;
                const totalAusentes = (record.ausentes_varones || 0) + (record.ausentes_mujeres || 0);
                pdfContent += `${record.grado}\t${record.seccion}\t${record.total_varones}\t${record.total_mujeres}\t${record.ausentes_varones || 0}\t${record.ausentes_mujeres || 0}\t${totalPresentes}\t${totalAusentes}\t${record.docente}\t${time}\n`;
            });
            
            // Calculate totals
            const totalVaronesPresentes = todayRecords.reduce((sum, record) => sum + record.total_varones, 0);
            const totalMujeresPresentes = todayRecords.reduce((sum, record) => sum + record.total_mujeres, 0);
            const totalVaronesAusentes = todayRecords.reduce((sum, record) => sum + (record.ausentes_varones || 0), 0);
            const totalMujeresAusentes = todayRecords.reduce((sum, record) => sum + (record.ausentes_mujeres || 0), 0);
            
            pdfContent += `\nRESUMEN:\n`;
            pdfContent += `Varones Presentes: ${totalVaronesPresentes}\n`;
            pdfContent += `Mujeres Presentes: ${totalMujeresPresentes}\n`;
            pdfContent += `Varones Ausentes: ${totalVaronesAusentes}\n`;
            pdfContent += `Mujeres Ausentes: ${totalMujeresAusentes}\n`;
            pdfContent += `Total Presentes: ${totalVaronesPresentes + totalMujeresPresentes}\n`;
            pdfContent += `Total Ausentes: ${totalVaronesAusentes + totalMujeresAusentes}\n`;
            
            // Download as text file (simulating PDF)
            const blob = new Blob([pdfContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `reporte_asistencia_${today}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showToast('Reporte PDF descargado', 'success');
        }

        // Download CSV report
        function downloadCSV() {
            const today = new Date().toISOString().split('T')[0];
            const todayRecords = attendanceRecords.filter(record => record.fecha === today);
            
            if (todayRecords.length === 0) {
                showToast('No hay registros para descargar', 'error');
                return;
            }
            
            // Create CSV content
            let csvContent = 'Grado,Sección,Presentes Varones,Presentes Mujeres,Ausentes Varones,Ausentes Mujeres,Total Presentes,Total Ausentes,Docente,Hora\n';
            
            todayRecords.forEach(record => {
                const time = new Date(record.timestamp).toLocaleTimeString('es-ES', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
                const totalPresentes = record.total_varones + record.total_mujeres;
                const totalAusentes = (record.ausentes_varones || 0) + (record.ausentes_mujeres || 0);
                csvContent += `${record.grado},${record.seccion},${record.total_varones},${record.total_mujeres},${record.ausentes_varones || 0},${record.ausentes_mujeres || 0},${totalPresentes},${totalAusentes},${record.docente},${time}\n`;
            });
            
            // Download CSV
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `asistencia_${today}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showToast('Reporte CSV descargado', 'success');
        }

        // Show toast notification
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            // Show toast
            setTimeout(() => toast.classList.add('show'), 100);
            
            // Hide and remove toast
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => document.body.removeChild(toast), 300);
            }, 3000);
        }

        // Initialize app when page loads
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'996e0efcc04e5c6d',t:'MTc2MTg2MDI5NS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
