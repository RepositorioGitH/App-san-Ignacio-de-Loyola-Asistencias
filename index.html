<!doctype html>
<html lang="es">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistema de Asistencia Escolar - Firebase</title><!-- Firebase SDK -->
  <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, addDoc, query, where, orderBy, getDocs, doc, getDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        
        // ConfiguraciÃ³n Firebase - San Ignacio
        const firebaseConfig = {
            apiKey: "AIzaSyDjkCjj1iLMi3Z22o6cj1Xa-yYDoqjBm04",
            authDomain: "base-de-datos-san-ignacio.firebaseapp.com",
            projectId: "base-de-datos-san-ignacio",
            storageBucket: "base-de-datos-san-ignacio.firebasestorage.app",
            messagingSenderId: "698408506523",
            appId: "1:698408506523:web:ede2c739a1920e8956a23e",
            measurementId: "G-Z16V5DDNB8"
        };

        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // Hacer disponibles globalmente
        window.firebaseAuth = auth;
        window.firebaseDb = db;
        window.firebaseModules = {
            signInWithEmailAndPassword,
            createUserWithEmailAndPassword,
            signOut,
            onAuthStateChanged,
            collection,
            addDoc,
            query,
            where,
            orderBy,
            getDocs,
            doc,
            getDoc,
            serverTimestamp
        };
    </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
        body {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100%;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
            padding: 10px;
            min-height: 100%;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            color: #2d3748;
            margin: 0 0 10px 0;
            font-size: 24px;
            font-weight: 700;
        }

        .header p {
            color: #4a5568;
            margin: 0;
            font-size: 14px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #2d3748;
            font-weight: 600;
            font-size: 14px;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
            box-sizing: border-box;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #4299e1;
        }

        .btn {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 10px;
        }

        .btn-primary {
            background: #4299e1;
            color: white;
        }

        .btn-primary:hover {
            background: #3182ce;
        }

        .btn-success {
            background: #48bb78;
            color: white;
        }

        .btn-success:hover {
            background: #38a169;
        }

        .btn-warning {
            background: #ed8936;
            color: white;
        }

        .btn-warning:hover {
            background: #dd6b20;
        }

        .btn-danger {
            background: #f56565;
            color: white;
        }

        .btn-danger:hover {
            background: #e53e3e;
        }

        .btn-secondary {
            background: #a0aec0;
            color: white;
        }

        .btn-secondary:hover {
            background: #718096;
        }



        .nav-tabs {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 5px;
            margin-bottom: 20px;
            background: rgba(255, 255, 255, 0.1);
            padding: 5px;
            border-radius: 12px;
        }

        .nav-tab {
            padding: 10px;
            text-align: center;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: white;
            font-weight: 600;
            font-size: 14px;
        }

        .nav-tab.active {
            background: rgba(255, 255, 255, 0.9);
            color: #2d3748;
        }

        .tab-content {
            display: none;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .tab-content.active {
            display: block;
        }

        .student-form {
            display: grid;
            gap: 15px;
            margin-bottom: 20px;
        }

        .attendance-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            gap: 8px;
            margin-top: 10px;
        }

        .attendance-btn {
            padding: 8px;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .attendance-list {
            max-height: 400px;
            overflow-y: auto;
            margin-top: 20px;
        }

        .attendance-item {
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 10px;
            align-items: center;
        }

        .attendance-info h4 {
            margin: 0 0 5px 0;
            color: #2d3748;
            font-size: 14px;
        }

        .attendance-info p {
            margin: 0;
            color: #4a5568;
            font-size: 12px;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-align: center;
        }

        .status-presente {
            background: #c6f6d5;
            color: #22543d;
        }

        .status-ausente {
            background: #fed7d7;
            color: #742a2a;
        }

        .status-tardanza {
            background: #feebc8;
            color: #7b341e;
        }

        .status-justificado {
            background: #bee3f8;
            color: #2a4365;
        }

        .user-info {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            color: white;
            text-align: center;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #4a5568;
        }

        .spinner {
            border: 3px solid #e2e8f0;
            border-top: 3px solid #4299e1;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            background: #fed7d7;
            color: #742a2a;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: none;
        }

        .success-message {
            background: #c6f6d5;
            color: #22543d;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: none;
        }

        .firebase-status {
            background: rgba(255, 255, 255, 0.1);
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            color: white;
            text-align: center;
            font-size: 12px;
        }

        .firebase-status.connected {
            background: rgba(72, 187, 120, 0.2);
        }

        .firebase-status.error {
            background: rgba(245, 101, 101, 0.2);
        }

        /* Estilos de AutenticaciÃ³n */
        .auth-screen {
            max-width: 500px;
            margin: 0 auto;
        }

        .auth-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .auth-tabs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 5px;
            margin-bottom: 25px;
            background: rgba(102, 126, 234, 0.1);
            padding: 5px;
            border-radius: 12px;
        }

        .auth-tab {
            padding: 12px;
            text-align: center;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #4a5568;
            font-weight: 600;
            font-size: 14px;
        }

        .auth-tab.active {
            background: #667eea;
            color: white;
        }

        .auth-form-container {
            display: none;
        }

        .auth-form-container.active {
            display: block;
        }

        .auth-form {
            display: grid;
            gap: 20px;
        }

        .auth-form h3 {
            text-align: center;
            color: #2d3748;
            margin: 0 0 20px 0;
            font-size: 24px;
        }

        .demo-accounts {
            margin-top: 25px;
            padding: 20px;
            background: rgba(102, 126, 234, 0.05);
            border-radius: 10px;
            border: 2px dashed rgba(102, 126, 234, 0.2);
        }

        .demo-accounts h4 {
            margin: 0 0 15px 0;
            color: #4a5568;
            font-size: 16px;
            text-align: center;
        }

        .demo-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .logout-section {
            background: rgba(255, 255, 255, 0.1);
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logout-btn {
            padding: 8px 15px;
            background: rgba(245, 101, 101, 0.8);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: rgba(245, 101, 101, 1);
        }

        .role-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-align: center;
        }

        .role-admin {
            background: #ffd700;
            color: #744210;
        }

        .role-user {
            background: #bee3f8;
            color: #2a4365;
        }

        @media (max-width: 480px) {
            .container {
                padding: 5px;
            }
            
            .header h1 {
                font-size: 20px;
            }
            
            .attendance-grid {
                grid-template-columns: 1fr 1fr;
                gap: 5px;
            }
            
            .attendance-btn {
                padding: 6px;
                font-size: 11px;
            }
            
            .nav-tabs {
                grid-template-columns: 1fr;
                gap: 2px;
            }
            
            .nav-tab {
                font-size: 12px;
                padding: 8px;
            }
        }
    </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="/_sdk/element_sdk.js" type="text/javascript"></script>
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
 </head>
 <body>
  <main class="container">
   <header class="header">
    <h1>Sistema de Asistencia Escolar - Firebase</h1>
    <p>AÃ±o AcadÃ©mico 2024-2025</p>
   </header><!-- Estado de Firebase -->
   <div id="firebase-status" class="firebase-status">
    ğŸ”„ Inicializando Firebase...
   </div><!-- Panel de DiagnÃ³stico Firebase (solo para desarrollo) -->
   <div id="firebase-debug" style="background: rgba(0,0,0,0.1); padding: 10px; border-radius: 8px; margin-bottom: 15px; font-size: 12px; color: white;">
    <div>
     <strong>ğŸ”§ DiagnÃ³stico Firebase:</strong>
    </div>
    <div id="debug-info">
     Cargando...
    </div>
    <div style="margin-top: 8px; display: grid; grid-template-columns: 1fr 1fr; gap: 5px;"><button onclick="testFirebaseManually()" style="padding: 5px 10px; background: #4299e1; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px;"> ğŸ§ª Probar ConexiÃ³n </button> <button onclick="testAttendanceSave()" style="padding: 5px 10px; background: #48bb78; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px;"> ğŸ’¾ Probar Guardado </button>
    </div>
   </div><!-- Pantalla de AutenticaciÃ³n -->
   <section id="auth-screen" class="auth-screen" style="display: none;">
    <div class="auth-container">
     <div class="auth-tabs">
      <div class="auth-tab active" data-auth-tab="login">
       ğŸ” Iniciar SesiÃ³n
      </div>
      <div class="auth-tab" data-auth-tab="register">
       ğŸ“ Registrarse
      </div>
     </div><!-- Login Form -->
     <div id="login-form-container" class="auth-form-container active">
      <h3>Iniciar SesiÃ³n</h3>
      <div class="error-message" id="login-error"></div>
      <div class="success-message" id="login-success"></div>
      <div class="loading" id="login-loading">
       <div class="spinner"></div> Iniciando sesiÃ³n...
      </div>
      <form id="login-form" class="auth-form">
       <div class="form-group"><label for="login-username">ğŸ‘¤ Usuario:</label> <input type="text" id="login-username" name="username" required placeholder="admin o user">
       </div>
       <div class="form-group"><label for="login-password">ğŸ”’ ContraseÃ±a:</label> <input type="password" id="login-password" name="password" required placeholder="Tu contraseÃ±a">
       </div><button type="submit" class="btn btn-primary">ğŸš€ Iniciar SesiÃ³n</button>
      </form>
      <div class="demo-accounts">
       <h4>ğŸ‘¥ Cuentas de DemostraciÃ³n:</h4>
       <div class="demo-buttons"><button class="btn btn-secondary" onclick="loginDemo('admin')"> ğŸ‘‘ Admin Demo </button> <button class="btn btn-secondary" onclick="loginDemo('user')"> ğŸ‘¤ Usuario Demo </button>
       </div>
      </div>
     </div><!-- Register Form -->
     <div id="register-form-container" class="auth-form-container">
      <h3>Crear Cuenta Nueva</h3>
      <div class="error-message" id="register-error"></div>
      <div class="success-message" id="register-success"></div>
      <div class="loading" id="register-loading">
       <div class="spinner"></div> Creando cuenta...
      </div>
      <form id="register-form" class="auth-form">
       <div class="form-group"><label for="register-name">ğŸ‘¤ Nombre Completo:</label> <input type="text" id="register-name" name="name" required placeholder="Ej: MarÃ­a GarcÃ­a LÃ³pez">
       </div>
       <div class="form-group"><label for="register-email">ğŸ“§ Correo ElectrÃ³nico:</label> <input type="email" id="register-email" name="email" required placeholder="usuario@sanignacio.edu">
       </div>
       <div class="form-group"><label for="register-password">ğŸ”’ ContraseÃ±a:</label> <input type="password" id="register-password" name="password" required placeholder="MÃ­nimo 6 caracteres">
       </div>
       <div class="form-group"><label for="register-role">ğŸ­ Rol de Usuario:</label> <select id="register-role" name="role" required> <option value="">Seleccionar rol</option> <option value="user">ğŸ‘¤ Usuario (Docente)</option> <option value="admin">ğŸ‘‘ Administrador (Director)</option> </select>
       </div>
       <div class="form-group"><label for="register-department">ğŸ« Departamento/Ãrea:</label> <select id="register-department" name="department" required> <option value="">Seleccionar departamento</option> <option value="primaria">ğŸ“š EducaciÃ³n Primaria</option> <option value="secundaria">ğŸ“ EducaciÃ³n Secundaria</option> <option value="matematicas">ğŸ”¢ MatemÃ¡ticas</option> <option value="ciencias">ğŸ”¬ Ciencias Naturales</option> <option value="lenguaje">ğŸ“– Lenguaje y Literatura</option> <option value="sociales">ğŸŒ Ciencias Sociales</option> <option value="educacion_fisica">âš½ EducaciÃ³n FÃ­sica</option> <option value="artes">ğŸ¨ Artes</option> <option value="administracion">ğŸ¢ AdministraciÃ³n</option> <option value="direccion">ğŸ‘‘ DirecciÃ³n</option> </select>
       </div><button type="submit" class="btn btn-success">âœ¨ Crear Cuenta</button>
      </form>
     </div>
    </div>
   </section><!-- AplicaciÃ³n Principal -->
   <section id="main-app" class="main-app" style="display: none;">
    <div class="logout-section">
     <div style="color: white;">
      <div id="user-welcome" style="font-weight: 600; margin-bottom: 2px;">
       Bienvenido, Usuario
      </div>
      <div style="font-size: 12px; opacity: 0.8;"><span id="user-email">email@sanignacio.edu</span> â€¢ <span class="role-badge" id="user-role-badge">Usuario</span>
      </div>
     </div><button class="logout-btn" onclick="handleLogout()">ğŸšª Cerrar SesiÃ³n</button>
    </div>
    <div class="user-info">
     <h3 id="user-department">Departamento: No asignado</h3>
     <p id="user-school">InstituciÃ³n: Colegio San Ignacio</p>
    </div>
    <nav class="nav-tabs">
     <div class="nav-tab active" data-tab="attendance">
      ğŸ“ Individual
     </div>
     <div class="nav-tab" data-tab="classroom">
      ğŸ« Por Aula
     </div>
     <div class="nav-tab" data-tab="reports">
      ğŸ“Š Reportes
     </div>
     <div class="nav-tab" data-tab="students" id="students-tab" style="display: none;">
      ğŸ‘¥ Estudiantes
     </div>
    </nav><!-- Tab de Asistencia Individual -->
    <div id="attendance-tab" class="tab-content active">
     <h3>Registro de Asistencia Individual</h3>
     <div class="success-message" id="attendance-success"></div>
     <div class="error-message" id="attendance-error"></div>
     <div class="loading" id="attendance-loading">
      <div class="spinner"></div> Guardando en Firebase...
     </div>
     <form id="attendance-form" class="student-form">
      <div class="form-group"><label for="student-name">Nombre del Estudiante:</label> <input type="text" id="student-name" name="student-name" required>
      </div>
      <div class="form-group"><label for="student-id">ID del Estudiante:</label> <input type="text" id="student-id" name="student-id" required>
      </div>
      <div class="form-group"><label for="attendance-date">Fecha:</label> <input type="date" id="attendance-date" name="attendance-date" required>
      </div>
      <div class="form-group"><label for="notes">Notas (opcional):</label> <input type="text" id="notes" name="notes" placeholder="Observaciones adicionales...">
      </div>
      <div class="attendance-grid"><button type="button" class="attendance-btn btn-success" data-status="presente"> âœ… Presente </button> <button type="button" class="attendance-btn btn-danger" data-status="ausente"> âŒ Ausente </button> <button type="button" class="attendance-btn btn-warning" data-status="tardanza"> â° Tardanza </button> <button type="button" class="attendance-btn btn-secondary" data-status="justificado"> ğŸ“‹ Justificado </button>
      </div>
     </form>
     <div class="attendance-list" id="attendance-list">
      <h4>Registros de Hoy (Firebase)</h4>
      <div id="today-records"></div>
     </div>
    </div><!-- Tab de Asistencia por Aula -->
    <div id="classroom-tab" class="tab-content">
     <h3>Asistencia por Aula</h3>
     <div class="success-message" id="classroom-success"></div>
     <div class="error-message" id="classroom-error"></div>
     <div class="loading" id="classroom-loading">
      <div class="spinner"></div> Guardando aula en Firebase...
     </div>
     <form id="classroom-form" class="student-form">
      <div class="form-group"><label for="classroom-grade">Grado:</label> <select id="classroom-grade" name="classroom-grade" required> <option value="">Seleccionar grado</option> <option value="7mo">7mo Grado</option> <option value="8vo">8vo Grado</option> <option value="9no">9no Grado</option> <option value="10mo">10mo Grado</option> <option value="11vo">11vo Grado</option> </select>
      </div>
      <div class="form-group"><label for="classroom-section">SecciÃ³n:</label> <select id="classroom-section" name="classroom-section" required> <option value="">Seleccionar secciÃ³n</option> <option value="A">SecciÃ³n A</option> <option value="B">SecciÃ³n B</option> <option value="C">SecciÃ³n C</option> <option value="D">SecciÃ³n D</option> </select>
      </div>
      <div class="form-group"><label for="classroom-date">Fecha:</label> <input type="date" id="classroom-date" name="classroom-date" required>
      </div>
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 20px 0;">
       <div class="form-group"><label for="male-present">ğŸ‘¦ Varones Presentes:</label> <input type="number" id="male-present" name="male-present" min="0" value="0" required>
       </div>
       <div class="form-group"><label for="female-present">ğŸ‘§ Mujeres Presentes:</label> <input type="number" id="female-present" name="female-present" min="0" value="0" required>
       </div>
      </div>
      <div class="form-group"><label for="total-absent">âŒ Total de Ausentes:</label> <input type="number" id="total-absent" name="total-absent" min="0" value="0" required>
      </div>
      <div class="form-group"><label for="total-enrolled">ğŸ‘¥ Total Matriculados en el Aula:</label> <input type="number" id="total-enrolled" name="total-enrolled" min="1" required>
      </div>
      <div class="form-group"><label for="classroom-notes">Observaciones (opcional):</label> <input type="text" id="classroom-notes" name="classroom-notes" placeholder="Notas adicionales sobre el aula...">
      </div><button type="submit" class="btn btn-primary">ğŸ’¾ Guardar en Firebase</button>
     </form>
     <div class="attendance-list" id="classroom-list">
      <h4>Registros de Aulas de Hoy (Firebase)</h4>
      <div id="today-classroom-records"></div>
     </div>
    </div><!-- Tab de Reportes -->
    <div id="reports-tab" class="tab-content">
     <h3>Generar Reportes desde Firebase</h3>
     <div class="success-message" id="report-success"></div>
     <div class="error-message" id="report-error"></div>
     <div class="loading" id="report-loading">
      <div class="spinner"></div> Consultando Firebase...
     </div>
     <div class="form-group"><label for="report-start-date">Fecha de Inicio:</label> <input type="date" id="report-start-date">
     </div>
     <div class="form-group"><label for="report-end-date">Fecha de Fin:</label> <input type="date" id="report-end-date">
     </div><button class="btn btn-success" onclick="generateFirebaseReport()"> ğŸ“Š Generar Reporte desde Firebase </button>
     <div id="report-summary" style="margin-top: 20px;"></div>
    </div><!-- Tab de Estudiantes (Solo Director) -->
    <div id="students-tab-content" class="tab-content">
     <h3>GestiÃ³n de Estudiantes (Firebase)</h3>
     <p>Funcionalidad disponible solo para directores</p>
     <div id="all-records"></div>
    </div>
   </section>
  </main>
  <script>
        // Variables globales
        let currentUser = null;
        let selectedStatus = null;
        let attendanceRecords = [];
        let classroomRecords = [];

        // Servicios Firebase
        class FirebaseUserService {
            constructor() {
                this.db = window.firebaseDb;
                this.modules = window.firebaseModules;
            }

            async createUserProfile(uid, userData) {
                try {
                    console.log('ğŸ”„ Creando perfil de usuario:', userData);
                    
                    const userProfile = {
                        uid: uid,
                        name: userData.name,
                        email: userData.email,
                        role: userData.role,
                        department: userData.department,
                        school_id: 'colegio-san-ignacio-123',
                        school_name: 'Colegio San Ignacio',
                        created_at: new Date().toISOString(),
                        timestamp: this.modules.serverTimestamp()
                    };

                    await this.modules.addDoc(
                        this.modules.collection(this.db, 'users'), 
                        userProfile
                    );
                    
                    console.log('âœ… Perfil de usuario creado exitosamente');
                    return { success: true, profile: userProfile };
                } catch (error) {
                    console.error('âŒ Error creating user profile:', error);
                    return { success: false, error: error.message };
                }
            }

            async getUserProfile(uid) {
                try {
                    const q = this.modules.query(
                        this.modules.collection(this.db, 'users'),
                        this.modules.where('uid', '==', uid)
                    );
                    
                    const querySnapshot = await this.modules.getDocs(q);
                    
                    if (!querySnapshot.empty) {
                        const userDoc = querySnapshot.docs[0];
                        return { success: true, profile: { id: userDoc.id, ...userDoc.data() } };
                    } else {
                        return { success: false, error: 'Perfil de usuario no encontrado' };
                    }
                } catch (error) {
                    console.error('âŒ Error getting user profile:', error);
                    return { success: false, error: error.message };
                }
            }
        }

        class FirebaseAttendanceService {
            constructor() {
                this.db = window.firebaseDb;
                this.modules = window.firebaseModules;
            }

            async createIndividualAttendance(attendanceData) {
                try {
                    console.log('ğŸ”„ Intentando guardar en Firebase:', attendanceData);
                    
                    // Verificaciones detalladas
                    if (!this.db) {
                        console.error('âŒ this.db no estÃ¡ disponible');
                        throw new Error('Firebase Database no estÃ¡ inicializado');
                    }
                    
                    if (!this.modules) {
                        console.error('âŒ this.modules no estÃ¡ disponible');
                        throw new Error('Firebase Modules no estÃ¡n inicializados');
                    }

                    if (!this.modules.addDoc) {
                        console.error('âŒ addDoc no estÃ¡ disponible en modules');
                        throw new Error('FunciÃ³n addDoc no estÃ¡ disponible');
                    }

                    if (!this.modules.collection) {
                        console.error('âŒ collection no estÃ¡ disponible en modules');
                        throw new Error('FunciÃ³n collection no estÃ¡ disponible');
                    }

                    if (!this.modules.serverTimestamp) {
                        console.error('âŒ serverTimestamp no estÃ¡ disponible en modules');
                        throw new Error('FunciÃ³n serverTimestamp no estÃ¡ disponible');
                    }

                    const docData = {
                        ...attendanceData,
                        timestamp: this.modules.serverTimestamp(),
                        created_at: new Date().toISOString(),
                        saved_from: 'web_app'
                    };

                    console.log('ğŸ“ Datos finales a guardar:', docData);
                    console.log('ğŸ—ï¸ Usando colecciÃ³n: attendance_individual');

                    const collectionRef = this.modules.collection(this.db, 'attendance_individual');
                    console.log('ğŸ“‚ Referencia de colecciÃ³n creada:', collectionRef);

                    const docRef = await this.modules.addDoc(collectionRef, docData);
                    
                    console.log('âœ… Documento guardado exitosamente con ID:', docRef.id);
                    return { success: true, id: docRef.id };
                } catch (error) {
                    console.error('âŒ Error completo creating individual attendance:', error);
                    console.error('âŒ Error code:', error.code);
                    console.error('âŒ Error message:', error.message);
                    console.error('âŒ Error stack:', error.stack);
                    
                    // DiagnÃ³stico adicional
                    console.log('ğŸ” DiagnÃ³stico del error:');
                    console.log('  - Firebase DB:', !!this.db);
                    console.log('  - Firebase Modules:', !!this.modules);
                    console.log('  - addDoc function:', !!this.modules?.addDoc);
                    console.log('  - collection function:', !!this.modules?.collection);
                    console.log('  - serverTimestamp function:', !!this.modules?.serverTimestamp);
                    
                    return { success: false, error: `${error.code || 'UNKNOWN'}: ${error.message}` };
                }
            }

            async createClassroomAttendance(classroomData) {
                try {
                    console.log('ğŸ”„ Intentando guardar aula en Firebase:', classroomData);
                    
                    if (!this.db || !this.modules) {
                        throw new Error('Firebase no estÃ¡ inicializado correctamente');
                    }

                    const docData = {
                        ...classroomData,
                        timestamp: this.modules.serverTimestamp(),
                        created_at: new Date().toISOString()
                    };

                    console.log('ğŸ“ Datos de aula a guardar:', docData);

                    const docRef = await this.modules.addDoc(
                        this.modules.collection(this.db, 'attendance_classroom'), 
                        docData
                    );
                    
                    console.log('âœ… Aula guardada con ID:', docRef.id);
                    return { success: true, id: docRef.id };
                } catch (error) {
                    console.error('âŒ Error creating classroom attendance:', error);
                    console.error('Error details:', error.code, error.message);
                    return { success: false, error: `${error.code || 'UNKNOWN'}: ${error.message}` };
                }
            }

            async getAttendanceByDate(schoolId, startDate, endDate, type = 'individual') {
                try {
                    const collectionName = type === 'individual' ? 'attendance_individual' : 'attendance_classroom';
                    const q = this.modules.query(
                        this.modules.collection(this.db, collectionName),
                        this.modules.where('school_id', '==', schoolId),
                        this.modules.where('date', '>=', startDate),
                        this.modules.where('date', '<=', endDate),
                        this.modules.orderBy('date', 'desc')
                    );
                    
                    const querySnapshot = await this.modules.getDocs(q);
                    const records = [];
                    querySnapshot.forEach((doc) => {
                        records.push({ id: doc.id, ...doc.data() });
                    });
                    
                    return { success: true, data: records };
                } catch (error) {
                    console.error('Error getting attendance:', error);
                    return { success: false, error: error.message };
                }
            }

            async getTodayAttendance(schoolId, type = 'individual') {
                const today = new Date().toISOString().split('T')[0];
                return this.getAttendanceByDate(schoolId, today, today, type);
            }
        }

        class FirebaseAuthService {
            constructor() {
                this.auth = window.firebaseAuth;
                this.db = window.firebaseDb;
                this.modules = window.firebaseModules;
            }

            async register(email, password, userData) {
                try {
                    console.log('ğŸ”„ Registrando usuario:', email);
                    
                    // Crear usuario en Firebase Auth
                    const userCredential = await this.modules.createUserWithEmailAndPassword(this.auth, email, password);
                    const user = userCredential.user;
                    
                    console.log('âœ… Usuario creado en Auth:', user.uid);
                    
                    // Crear perfil en Firestore
                    const userService = new FirebaseUserService();
                    const profileResult = await userService.createUserProfile(user.uid, {
                        ...userData,
                        email: user.email
                    });
                    
                    if (!profileResult.success) {
                        throw new Error('Error creando perfil: ' + profileResult.error);
                    }
                    
                    return { 
                        success: true, 
                        user: { 
                            uid: user.uid, 
                            email: user.email, 
                            ...profileResult.profile 
                        } 
                    };
                } catch (error) {
                    console.error('âŒ Register error:', error);
                    return { success: false, error: this.getErrorMessage(error.code) || error.message };
                }
            }

            async login(email, password) {
                try {
                    console.log('ğŸ”„ Iniciando sesiÃ³n:', email);
                    
                    const userCredential = await this.modules.signInWithEmailAndPassword(this.auth, email, password);
                    const user = userCredential.user;
                    
                    console.log('âœ… Usuario autenticado:', user.uid);
                    
                    // Obtener perfil del usuario
                    const userService = new FirebaseUserService();
                    const profileResult = await userService.getUserProfile(user.uid);
                    
                    if (!profileResult.success) {
                        throw new Error('Perfil de usuario no encontrado');
                    }
                    
                    return { 
                        success: true, 
                        user: { 
                            uid: user.uid, 
                            email: user.email, 
                            ...profileResult.profile 
                        } 
                    };
                } catch (error) {
                    console.error('âŒ Login error:', error);
                    return { success: false, error: this.getErrorMessage(error.code) || error.message };
                }
            }

            async logout() {
                try {
                    await this.modules.signOut(this.auth);
                    return { success: true };
                } catch (error) {
                    return { success: false, error: error.message };
                }
            }

            onAuthChange(callback) {
                return this.modules.onAuthStateChanged(this.auth, async (user) => {
                    if (user) {
                        try {
                            const userService = new FirebaseUserService();
                            const profileResult = await userService.getUserProfile(user.uid);
                            
                            if (profileResult.success) {
                                callback({ 
                                    uid: user.uid, 
                                    email: user.email, 
                                    ...profileResult.profile 
                                });
                            } else {
                                callback(null);
                            }
                        } catch (error) {
                            console.error('Error getting user data:', error);
                            callback(null);
                        }
                    } else {
                        callback(null);
                    }
                });
            }

            getErrorMessage(errorCode) {
                const errorMessages = {
                    'auth/email-already-in-use': 'Este correo electrÃ³nico ya estÃ¡ registrado',
                    'auth/weak-password': 'La contraseÃ±a debe tener al menos 6 caracteres',
                    'auth/invalid-email': 'Correo electrÃ³nico invÃ¡lido',
                    'auth/user-not-found': 'Usuario no encontrado',
                    'auth/wrong-password': 'ContraseÃ±a incorrecta',
                    'auth/too-many-requests': 'Demasiados intentos fallidos. Intenta mÃ¡s tarde',
                    'auth/network-request-failed': 'Error de conexiÃ³n. Verifica tu internet'
                };
                return errorMessages[errorCode] || 'Error de autenticaciÃ³n';
            }
        }

        // Instancias de servicios
        let attendanceService;
        let authService;
        let userService;

        // InicializaciÃ³n
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸš€ DOM cargado, inicializando aplicaciÃ³n...');
            
            // Mostrar pantalla de auth por defecto
            showAuthScreen();
            
            // Inicializar app
            initializeApp().catch(error => {
                console.error('âŒ Error fatal en inicializaciÃ³n:', error);
                updateFirebaseStatus('error', 'âŒ Error fatal: ' + error.message);
                // Asegurar que se muestre la pantalla de auth
                showAuthScreen();
            });
        });

        async function initializeApp() {
            try {
                console.log('ğŸš€ Iniciando aplicaciÃ³n...');
                
                // Esperar a que Firebase estÃ© disponible (solo para datos)
                await waitForFirebase();
                console.log('âœ… Firebase disponible para datos');

                // Inicializar solo servicios necesarios
                attendanceService = new FirebaseAttendanceService();
                userService = new FirebaseUserService();
                console.log('âœ… Servicios de datos inicializados');

                setupEventListeners();
                setTodayDate();

                // Mostrar pantalla de login (sin Firebase Auth)
                showAuthScreen();
                updateFirebaseStatus('connected', 'âœ… Sistema listo - Login local activo');

                // Probar conexiÃ³n bÃ¡sica a Firebase (solo para datos)
                try {
                    await testFirebaseConnection();
                    console.log('âœ… ConexiÃ³n a Firebase exitosa para datos');
                    updateFirebaseStatus('connected', 'âœ… Firebase conectado para datos - Login local');
                } catch (error) {
                    console.warn('âš ï¸ ConexiÃ³n inicial fallÃ³, pero continuando:', error);
                    updateFirebaseStatus('connected', 'âš ï¸ Firebase para datos - Login local activo');
                }

                console.log('ğŸ‰ AplicaciÃ³n inicializada correctamente con login local');

            } catch (error) {
                console.error('âŒ Error crÃ­tico inicializando aplicaciÃ³n:', error);
                updateFirebaseStatus('error', 'âŒ Error crÃ­tico: ' + error.message);
                // Asegurar que se muestre la pantalla de auth
                showAuthScreen();
            }
        }

        function waitForFirebase() {
            return new Promise((resolve, reject) => {
                let attempts = 0;
                const maxAttempts = 50;
                
                const checkFirebase = () => {
                    attempts++;
                    if (window.firebaseDb && window.firebaseModules) {
                        resolve();
                    } else if (attempts >= maxAttempts) {
                        reject(new Error('Firebase no se cargÃ³ correctamente'));
                    } else {
                        setTimeout(checkFirebase, 100);
                    }
                };
                
                checkFirebase();
            });
        }

        async function testFirebaseConnection() {
            try {
                console.log('ğŸ”„ Probando conexiÃ³n a Firebase...');
                console.log('ğŸ“Š Firebase DB disponible:', !!window.firebaseDb);
                console.log('ğŸ› ï¸ Firebase Modules disponible:', !!window.firebaseModules);
                
                if (!window.firebaseDb || !window.firebaseModules) {
                    throw new Error('Firebase SDK no estÃ¡ completamente cargado');
                }

                // Intentar crear una colecciÃ³n de prueba
                const testDoc = {
                    test: true,
                    timestamp: new Date().toISOString(),
                    school_id: 'test-connection',
                    created_by: 'system_test'
                };
                
                console.log('ğŸ“ Creando documento de prueba:', testDoc);
                
                const docRef = await window.firebaseModules.addDoc(
                    window.firebaseModules.collection(window.firebaseDb, 'connection_test'), 
                    testDoc
                );
                
                console.log('âœ… ConexiÃ³n a Firebase exitosa. Test doc ID:', docRef.id);
                return true;
            } catch (error) {
                console.error('âŒ Error de conexiÃ³n a Firebase:', error);
                console.error('âŒ Error code:', error.code);
                console.error('âŒ Error message:', error.message);
                throw error;
            }
        }

        function updateFirebaseStatus(status, message) {
            const statusElement = document.getElementById('firebase-status');
            statusElement.className = `firebase-status ${status}`;
            statusElement.textContent = message;
        }

        function setupEventListeners() {
            // Tabs de autenticaciÃ³n
            document.querySelectorAll('.auth-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabName = this.dataset.authTab;
                    switchAuthTab(tabName);
                });
            });

            // Forms de autenticaciÃ³n
            document.getElementById('login-form').addEventListener('submit', handleLogin);
            document.getElementById('register-form').addEventListener('submit', handleRegister);

            // Tabs de navegaciÃ³n
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabName = this.dataset.tab;
                    switchTab(tabName);
                });
            });

            // Botones de asistencia
            document.querySelectorAll('.attendance-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    selectAttendanceStatus(this.dataset.status);
                });
            });

            // Forms
            document.getElementById('attendance-form').addEventListener('submit', handleFirebaseAttendanceSubmit);
            document.getElementById('classroom-form').addEventListener('submit', handleFirebaseClassroomSubmit);

            // Reportes
            document.getElementById('report-start-date').addEventListener('change', updateFirebaseReportSummary);
            document.getElementById('report-end-date').addEventListener('change', updateFirebaseReportSummary);
        }

        function showAuthScreen() {
            document.getElementById('auth-screen').style.display = 'block';
            document.getElementById('main-app').style.display = 'none';
        }

        function showMainApp() {
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('main-app').style.display = 'block';
        }

        function switchAuthTab(tabName) {
            // Actualizar tabs activos
            document.querySelectorAll('.auth-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[data-auth-tab="${tabName}"]`).classList.add('active');

            // Mostrar contenido correspondiente
            document.querySelectorAll('.auth-form-container').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`${tabName}-form-container`).classList.add('active');
        }

        function updateUserInterface() {
            if (!currentUser) return;

            // Actualizar informaciÃ³n del usuario
            document.getElementById('user-welcome').textContent = `Bienvenido, ${currentUser.name}`;
            document.getElementById('user-email').textContent = currentUser.email;
            document.getElementById('user-department').textContent = `Departamento: ${getDepartmentName(currentUser.department)}`;
            
            // Actualizar badge de rol
            const roleBadge = document.getElementById('user-role-badge');
            roleBadge.textContent = currentUser.role === 'admin' ? 'ğŸ‘‘ Administrador' : 'ğŸ‘¤ Usuario';
            roleBadge.className = `role-badge ${currentUser.role === 'admin' ? 'role-admin' : 'role-user'}`;

            // Mostrar/ocultar tabs segÃºn el rol
            const studentsTab = document.getElementById('students-tab');
            if (currentUser.role === 'admin') {
                studentsTab.style.display = 'block';
            } else {
                studentsTab.style.display = 'none';
            }
        }

        function getDepartmentName(department) {
            const departments = {
                'primaria': 'ğŸ“š EducaciÃ³n Primaria',
                'secundaria': 'ğŸ“ EducaciÃ³n Secundaria',
                'matematicas': 'ğŸ”¢ MatemÃ¡ticas',
                'ciencias': 'ğŸ”¬ Ciencias Naturales',
                'lenguaje': 'ğŸ“– Lenguaje y Literatura',
                'sociales': 'ğŸŒ Ciencias Sociales',
                'educacion_fisica': 'âš½ EducaciÃ³n FÃ­sica',
                'artes': 'ğŸ¨ Artes',
                'administracion': 'ğŸ¢ AdministraciÃ³n',
                'direccion': 'ğŸ‘‘ DirecciÃ³n'
            };
            return departments[department] || department;
        }

        async function handleLogin(e) {
            e.preventDefault();

            const formData = new FormData(e.target);
            const username = formData.get('username');
            const password = formData.get('password');

            console.log('ğŸ”„ Intentando login local con usuario:', username);

            if (!username || !password) {
                showError('login-error', 'Por favor completa todos los campos');
                return;
            }

            // Limpiar errores previos
            document.getElementById('login-error').style.display = 'none';
            showLoading('login-loading', true);

            // Simular tiempo de carga
            setTimeout(() => {
                // Credenciales locales (sin Firebase)
                const validCredentials = {
                    'admin': {
                        password: 'admin123',
                        user: {
                            uid: 'local-admin-001',
                            name: 'Administrador Local',
                            email: 'admin@sanignacio.edu',
                            role: 'admin',
                            department: 'direccion',
                            school_id: 'colegio-san-ignacio-123',
                            school_name: 'Colegio San Ignacio'
                        }
                    },
                    'user': {
                        password: 'user123',
                        user: {
                            uid: 'local-user-001',
                            name: 'Usuario Local',
                            email: 'user@sanignacio.edu',
                            role: 'user',
                            department: 'primaria',
                            school_id: 'colegio-san-ignacio-123',
                            school_name: 'Colegio San Ignacio'
                        }
                    }
                };

                showLoading('login-loading', false);

                if (validCredentials[username] && validCredentials[username].password === password) {
                    console.log('âœ… Login local exitoso para:', username);
                    currentUser = validCredentials[username].user;
                    showSuccess('login-success', 'âœ… Iniciando sesiÃ³n...');
                    
                    setTimeout(() => {
                        showMainApp();
                        updateUserInterface();
                        loadTodayData();
                        updateFirebaseStatus('connected', `âœ… SesiÃ³n local activa: ${currentUser.name}`);
                    }, 1000);
                } else {
                    console.error('âŒ Credenciales incorrectas');
                    showError('login-error', 'âŒ Usuario o contraseÃ±a incorrectos');
                }
            }, 800);
        }

        async function handleRegister(e) {
            e.preventDefault();

            const formData = new FormData(e.target);
            const name = formData.get('name');
            const email = formData.get('email');
            const password = formData.get('password');
            const role = formData.get('role');
            const department = formData.get('department');

            if (!name || !email || !password || !role || !department) {
                showError('register-error', 'Por favor completa todos los campos');
                return;
            }

            if (password.length < 6) {
                showError('register-error', 'La contraseÃ±a debe tener al menos 6 caracteres');
                return;
            }

            showLoading('register-loading', true);

            const result = await authService.register(email, password, {
                name: name,
                role: role,
                department: department
            });
            
            showLoading('register-loading', false);

            if (result.success) {
                showSuccess('register-success', `âœ… Cuenta creada exitosamente para ${name}. Iniciando sesiÃ³n...`);
                e.target.reset();
                
                // Cambiar a tab de login despuÃ©s de un momento
                setTimeout(() => {
                    switchAuthTab('login');
                }, 2000);
            } else {
                showError('register-error', `âŒ ${result.error}`);
            }
        }

        async function handleLogout() {
            console.log('ğŸ”„ Cerrando sesiÃ³n local...');
            
            // Limpiar usuario actual
            currentUser = null;
            
            // Mostrar pantalla de login
            showAuthScreen();
            
            // Actualizar estado
            updateFirebaseStatus('connected', 'âœ… SesiÃ³n cerrada - Login local disponible');
            
            console.log('âœ… Logout local exitoso');
        }

        async function loginDemo(role) {
            console.log(`ğŸ”„ Iniciando login demo local para rol: ${role}`);
            
            // Limpiar errores previos
            document.getElementById('login-error').style.display = 'none';
            document.getElementById('login-success').style.display = 'none';
            showLoading('login-loading', true);

            // Simular tiempo de carga
            setTimeout(() => {
                // Credenciales locales de demostraciÃ³n
                const demoUsers = {
                    admin: {
                        uid: 'local-admin-001',
                        name: 'Administrador Demo',
                        email: 'admin@sanignacio.edu',
                        role: 'admin',
                        department: 'direccion',
                        school_id: 'colegio-san-ignacio-123',
                        school_name: 'Colegio San Ignacio'
                    },
                    user: {
                        uid: 'local-user-001',
                        name: 'Usuario Demo',
                        email: 'user@sanignacio.edu',
                        role: 'user',
                        department: 'primaria',
                        school_id: 'colegio-san-ignacio-123',
                        school_name: 'Colegio San Ignacio'
                    }
                };

                showLoading('login-loading', false);

                if (demoUsers[role]) {
                    console.log('âœ… Login demo local exitoso:', role);
                    currentUser = demoUsers[role];
                    showSuccess('login-success', `âœ… Acceso demo como ${role === 'admin' ? 'Administrador' : 'Usuario'}`);
                    
                    setTimeout(() => {
                        showMainApp();
                        updateUserInterface();
                        loadTodayData();
                        updateFirebaseStatus('connected', `âœ… SesiÃ³n demo local: ${currentUser.name}`);
                    }, 1000);
                } else {
                    showError('login-error', 'Rol de demostraciÃ³n no vÃ¡lido');
                }
            }, 600);
        }

        function setTodayDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('attendance-date').value = today;
            document.getElementById('classroom-date').value = today;
            document.getElementById('report-start-date').value = today;
            document.getElementById('report-end-date').value = today;
        }



        function switchTab(tabName) {
            // Actualizar tabs activos
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

            // Mostrar contenido correspondiente
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`${tabName}-tab`).classList.add('active');

            // Cargar datos especÃ­ficos del tab
            if (tabName === 'students' && currentUser.role === 'director') {
                loadAllFirebaseRecords();
            } else if (tabName === 'reports') {
                updateFirebaseReportSummary();
            }
        }

        function selectAttendanceStatus(status) {
            selectedStatus = status;
            
            // Actualizar botones
            document.querySelectorAll('.attendance-btn').forEach(btn => {
                btn.style.opacity = btn.dataset.status === status ? '1' : '0.5';
                btn.style.transform = btn.dataset.status === status ? 'scale(1.05)' : 'scale(1)';
            });
        }

        async function handleFirebaseAttendanceSubmit(e) {
            e.preventDefault();

            if (!selectedStatus) {
                showError('attendance-error', 'Por favor selecciona un estado de asistencia');
                return;
            }

            if (!currentUser || !currentUser.school_id) {
                showError('attendance-error', 'Error: Usuario no tiene escuela asignada');
                return;
            }

            const formData = new FormData(e.target);
            const studentName = formData.get('student-name');
            const studentId = formData.get('student-id');
            const date = formData.get('attendance-date');
            const notes = formData.get('notes') || '';

            showLoading('attendance-loading', true);

            const attendanceRecord = {
                student_name: studentName,
                student_id: studentId,
                date: date,
                status: selectedStatus,
                teacher_id: currentUser.uid,
                teacher_name: currentUser.name || currentUser.email,
                school_id: currentUser.school_id,
                notes: notes
            };

            const result = await attendanceService.createIndividualAttendance(attendanceRecord);
            
            showLoading('attendance-loading', false);

            if (result.success) {
                showSuccess('attendance-success', `âœ… Asistencia guardada en Firebase para ${studentName}`);
                e.target.reset();
                setTodayDate();
                selectedStatus = null;
                
                // Resetear botones
                document.querySelectorAll('.attendance-btn').forEach(btn => {
                    btn.style.opacity = '1';
                    btn.style.transform = 'scale(1)';
                });

                // Recargar datos
                loadTodayData();
            } else {
                showError('attendance-error', `âŒ Error de Firebase: ${result.error}`);
            }
        }

        async function handleFirebaseClassroomSubmit(e) {
            e.preventDefault();

            if (!currentUser || !currentUser.school_id) {
                showError('classroom-error', 'Error: Usuario no tiene escuela asignada');
                return;
            }

            const formData = new FormData(e.target);
            const grade = formData.get('classroom-grade');
            const section = formData.get('classroom-section');
            const date = formData.get('classroom-date');
            const malePresent = parseInt(formData.get('male-present')) || 0;
            const femalePresent = parseInt(formData.get('female-present')) || 0;
            const totalAbsent = parseInt(formData.get('total-absent')) || 0;
            const totalEnrolled = parseInt(formData.get('total-enrolled')) || 0;
            const notes = formData.get('classroom-notes') || '';

            // Validaciones
            const totalPresent = malePresent + femalePresent;
            if (totalPresent + totalAbsent !== totalEnrolled) {
                showError('classroom-error', `âŒ Error: Los presentes (${totalPresent}) + ausentes (${totalAbsent}) deben sumar el total matriculado (${totalEnrolled})`);
                return;
            }

            showLoading('classroom-loading', true);

            const classroomRecord = {
                grade: grade,
                section: section,
                date: date,
                male_present: malePresent,
                female_present: femalePresent,
                total_absent: totalAbsent,
                total_enrolled: totalEnrolled,
                teacher_id: currentUser.uid,
                teacher_name: currentUser.name || currentUser.email,
                school_id: currentUser.school_id,
                notes: notes
            };

            const result = await attendanceService.createClassroomAttendance(classroomRecord);
            
            showLoading('classroom-loading', false);

            if (result.success) {
                showSuccess('classroom-success', `âœ… Aula guardada en Firebase: ${grade} ${section} - ${totalPresent} presentes, ${totalAbsent} ausentes`);
                e.target.reset();
                setTodayDate();
                loadTodayData();
            } else {
                showError('classroom-error', `âŒ Error de Firebase: ${result.error}`);
            }
        }

        async function loadTodayData() {
            if (!currentUser || !currentUser.school_id) return;

            try {
                // Cargar asistencia individual
                const individualResult = await attendanceService.getTodayAttendance(currentUser.school_id, 'individual');
                if (individualResult.success) {
                    attendanceRecords = individualResult.data;
                    updateAttendanceDisplay();
                }

                // Cargar asistencia por aula
                const classroomResult = await attendanceService.getTodayAttendance(currentUser.school_id, 'classroom');
                if (classroomResult.success) {
                    classroomRecords = classroomResult.data;
                    updateClassroomDisplay();
                }
            } catch (error) {
                console.error('Error loading today data:', error);
            }
        }

        function updateAttendanceDisplay() {
            const container = document.getElementById('today-records');
            
            if (attendanceRecords.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #4a5568; padding: 20px;">ğŸ“­ No hay registros individuales para hoy en Firebase</p>';
                return;
            }

            container.innerHTML = attendanceRecords.map(record => `
                <div class="attendance-item">
                    <div class="attendance-info">
                        <h4>${record.student_name} (ID: ${record.student_id})</h4>
                        <p>ğŸ‘¨â€ğŸ« Docente: ${record.teacher_name}</p>
                        ${record.notes ? `<p>ğŸ“ Notas: ${record.notes}</p>` : ''}
                        <p style="font-size: 10px; color: #718096;">ğŸ”¥ Firebase ID: ${record.id}</p>
                    </div>
                    <div class="status-badge status-${record.status}">
                        ${getStatusText(record.status)}
                    </div>
                </div>
            `).join('');
        }

        function updateClassroomDisplay() {
            const container = document.getElementById('today-classroom-records');
            
            if (classroomRecords.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #4a5568; padding: 20px;">ğŸ“­ No hay registros de aulas para hoy en Firebase</p>';
                return;
            }

            container.innerHTML = classroomRecords.map(record => `
                <div class="attendance-item">
                    <div class="attendance-info">
                        <h4>ğŸ« ${record.grade} - SecciÃ³n ${record.section}</h4>
                        <p>ğŸ‘¦ Varones: ${record.male_present} | ğŸ‘§ Mujeres: ${record.female_present}</p>
                        <p>âŒ Ausentes: ${record.total_absent} | ğŸ‘¥ Total: ${record.total_enrolled}</p>
                        <p>ğŸ‘¨â€ğŸ« Docente: ${record.teacher_name}</p>
                        ${record.notes ? `<p>ğŸ“ Notas: ${record.notes}</p>` : ''}
                        <p style="font-size: 10px; color: #718096;">ğŸ”¥ Firebase ID: ${record.id}</p>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 24px; font-weight: bold; color: #48bb78;">
                            ${record.male_present + record.female_present}
                        </div>
                        <div style="font-size: 12px; color: #4a5568;">Presentes</div>
                    </div>
                </div>
            `).join('');
        }

        async function generateFirebaseReport() {
            const startDate = document.getElementById('report-start-date').value;
            const endDate = document.getElementById('report-end-date').value;

            if (!startDate || !endDate) {
                showError('report-error', 'Por favor selecciona las fechas de inicio y fin');
                return;
            }

            if (!currentUser || !currentUser.school_id) {
                showError('report-error', 'Error: Usuario no tiene escuela asignada');
                return;
            }

            showLoading('report-loading', true);

            try {
                // Obtener datos de Firebase
                const [individualResult, classroomResult] = await Promise.all([
                    attendanceService.getAttendanceByDate(currentUser.school_id, startDate, endDate, 'individual'),
                    attendanceService.getAttendanceByDate(currentUser.school_id, startDate, endDate, 'classroom')
                ]);

                if (!individualResult.success || !classroomResult.success) {
                    throw new Error('Error al obtener datos de Firebase');
                }

                const individualData = individualResult.data;
                const classroomData = classroomResult.data;

                if (individualData.length === 0 && classroomData.length === 0) {
                    showLoading('report-loading', false);
                    showError('report-error', 'No hay registros en Firebase para el rango de fechas seleccionado');
                    return;
                }

                // Preparar datos para Excel - Registros Individuales
                const individualExcelData = individualData.map(record => ({
                    'Fecha': record.date,
                    'Nombre del Estudiante': record.student_name,
                    'ID Estudiante': record.student_id,
                    'Estado': getStatusText(record.status),
                    'Docente': record.teacher_name,
                    'Notas': record.notes || '',
                    'Firebase ID': record.id,
                    'Hora de Registro': record.timestamp ? new Date(record.timestamp.seconds * 1000).toLocaleString('es-ES') : 'N/A'
                }));

                // Preparar datos para Excel - Registros por Aula
                const classroomExcelData = classroomData.map(record => ({
                    'Fecha': record.date,
                    'Grado': record.grade,
                    'SecciÃ³n': record.section,
                    'Varones Presentes': record.male_present,
                    'Mujeres Presentes': record.female_present,
                    'Total Presentes': record.male_present + record.female_present,
                    'Total Ausentes': record.total_absent,
                    'Total Matriculados': record.total_enrolled,
                    'Docente': record.teacher_name,
                    'Notas': record.notes || '',
                    'Firebase ID': record.id,
                    'Hora de Registro': record.timestamp ? new Date(record.timestamp.seconds * 1000).toLocaleString('es-ES') : 'N/A'
                }));

                // Crear libro de Excel
                const wb = XLSX.utils.book_new();

                // Hoja de registros individuales
                if (individualExcelData.length > 0) {
                    const wsIndividual = XLSX.utils.json_to_sheet(individualExcelData);
                    const colWidthsIndividual = [
                        { wch: 12 }, { wch: 25 }, { wch: 15 }, { wch: 12 }, 
                        { wch: 20 }, { wch: 30 }, { wch: 20 }, { wch: 20 }
                    ];
                    wsIndividual['!cols'] = colWidthsIndividual;
                    XLSX.utils.book_append_sheet(wb, wsIndividual, 'Asistencia Individual');
                }

                // Hoja de registros por aula
                if (classroomExcelData.length > 0) {
                    const wsClassroom = XLSX.utils.json_to_sheet(classroomExcelData);
                    const colWidthsClassroom = [
                        { wch: 12 }, { wch: 10 }, { wch: 10 }, { wch: 15 }, { wch: 15 }, 
                        { wch: 15 }, { wch: 15 }, { wch: 15 }, { wch: 20 }, { wch: 30 }, 
                        { wch: 20 }, { wch: 20 }
                    ];
                    wsClassroom['!cols'] = colWidthsClassroom;
                    XLSX.utils.book_append_sheet(wb, wsClassroom, 'Asistencia por Aula');
                }

                // Generar nombre de archivo
                const fileName = `Reporte_Firebase_${currentUser.school_name || 'Escuela'}_${startDate}_${endDate}.xlsx`;

                // Descargar archivo
                XLSX.writeFile(wb, fileName);

                showLoading('report-loading', false);
                showSuccess('report-success', `ğŸ“Š Reporte de Firebase generado: ${fileName}`);

            } catch (error) {
                showLoading('report-loading', false);
                showError('report-error', `âŒ Error generando reporte: ${error.message}`);
            }
        }

        async function updateFirebaseReportSummary() {
            const startDate = document.getElementById('report-start-date').value;
            const endDate = document.getElementById('report-end-date').value;

            if (!startDate || !endDate || !currentUser || !currentUser.school_id) return;

            try {
                const [individualResult, classroomResult] = await Promise.all([
                    attendanceService.getAttendanceByDate(currentUser.school_id, startDate, endDate, 'individual'),
                    attendanceService.getAttendanceByDate(currentUser.school_id, startDate, endDate, 'classroom')
                ]);

                if (!individualResult.success || !classroomResult.success) return;

                const individualRecords = individualResult.data;
                const classroomRecords = classroomResult.data;

                // Resumen individual
                const individualSummary = {
                    total: individualRecords.length,
                    presente: individualRecords.filter(r => r.status === 'presente').length,
                    ausente: individualRecords.filter(r => r.status === 'ausente').length,
                    tardanza: individualRecords.filter(r => r.status === 'tardanza').length,
                    justificado: individualRecords.filter(r => r.status === 'justificado').length
                };

                // Resumen por aula
                const classroomSummary = {
                    totalAulas: classroomRecords.length,
                    totalVarones: classroomRecords.reduce((sum, r) => sum + (r.male_present || 0), 0),
                    totalMujeres: classroomRecords.reduce((sum, r) => sum + (r.female_present || 0), 0),
                    totalAusentes: classroomRecords.reduce((sum, r) => sum + (r.total_absent || 0), 0),
                    totalMatriculados: classroomRecords.reduce((sum, r) => sum + (r.total_enrolled || 0), 0)
                };

                const summaryContainer = document.getElementById('report-summary');
                summaryContainer.innerHTML = `
                    <div style="background: #f7fafc; padding: 15px; border-radius: 8px; margin-top: 15px;">
                        <h4 style="margin: 0 0 15px 0; color: #2d3748;">ğŸ“Š Resumen desde Firebase</h4>
                        
                        ${individualRecords.length > 0 ? `
                        <div style="margin-bottom: 20px;">
                            <h5 style="margin: 0 0 10px 0; color: #4a5568;">ğŸ‘¤ Asistencia Individual</h5>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 8px;">
                                <div style="text-align: center; padding: 8px; background: white; border-radius: 6px;">
                                    <div style="font-size: 18px; font-weight: bold; color: #2d3748;">${individualSummary.total}</div>
                                    <div style="font-size: 11px; color: #4a5568;">Total</div>
                                </div>
                                <div style="text-align: center; padding: 8px; background: #c6f6d5; border-radius: 6px;">
                                    <div style="font-size: 18px; font-weight: bold; color: #22543d;">${individualSummary.presente}</div>
                                    <div style="font-size: 11px; color: #22543d;">Presentes</div>
                                </div>
                                <div style="text-align: center; padding: 8px; background: #fed7d7; border-radius: 6px;">
                                    <div style="font-size: 18px; font-weight: bold; color: #742a2a;">${individualSummary.ausente}</div>
                                    <div style="font-size: 11px; color: #742a2a;">Ausentes</div>
                                </div>
                                <div style="text-align: center; padding: 8px; background: #feebc8; border-radius: 6px;">
                                    <div style="font-size: 18px; font-weight: bold; color: #7b341e;">${individualSummary.tardanza}</div>
                                    <div style="font-size: 11px; color: #7b341e;">Tardanzas</div>
                                </div>
                            </div>
                        </div>
                        ` : ''}
                        
                        ${classroomRecords.length > 0 ? `
                        <div>
                            <h5 style="margin: 0 0 10px 0; color: #4a5568;">ğŸ« Asistencia por Aula</h5>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 8px;">
                                <div style="text-align: center; padding: 8px; background: white; border-radius: 6px;">
                                    <div style="font-size: 18px; font-weight: bold; color: #2d3748;">${classroomSummary.totalAulas}</div>
                                    <div style="font-size: 11px; color: #4a5568;">Aulas</div>
                                </div>
                                <div style="text-align: center; padding: 8px; background: #bee3f8; border-radius: 6px;">
                                    <div style="font-size: 18px; font-weight: bold; color: #2a4365;">${classroomSummary.totalVarones}</div>
                                    <div style="font-size: 11px; color: #2a4365;">ğŸ‘¦ Varones</div>
                                </div>
                                <div style="text-align: center; padding: 8px; background: #fbb6ce; border-radius: 6px;">
                                    <div style="font-size: 18px; font-weight: bold; color: #97266d;">${classroomSummary.totalMujeres}</div>
                                    <div style="font-size: 11px; color: #97266d;">ğŸ‘§ Mujeres</div>
                                </div>
                                <div style="text-align: center; padding: 8px; background: #fed7d7; border-radius: 6px;">
                                    <div style="font-size: 18px; font-weight: bold; color: #742a2a;">${classroomSummary.totalAusentes}</div>
                                    <div style="font-size: 11px; color: #742a2a;">âŒ Ausentes</div>
                                </div>
                                <div style="text-align: center; padding: 8px; background: #c6f6d5; border-radius: 6px;">
                                    <div style="font-size: 18px; font-weight: bold; color: #22543d;">${classroomSummary.totalVarones + classroomSummary.totalMujeres}</div>
                                    <div style="font-size: 11px; color: #22543d;">âœ… Presentes</div>
                                </div>
                            </div>
                        </div>
                        ` : ''}
                        
                        ${individualRecords.length === 0 && classroomRecords.length === 0 ? '<p style="text-align: center; color: #4a5568; margin: 0;">ğŸ“­ No hay registros en Firebase para el perÃ­odo seleccionado</p>' : ''}
                    </div>
                `;
            } catch (error) {
                console.error('Error updating report summary:', error);
            }
        }

        async function loadAllFirebaseRecords() {
            if (!currentUser || !currentUser.school_id || currentUser.role !== 'director') return;

            const container = document.getElementById('all-records');
            container.innerHTML = '<p style="text-align: center; color: #4a5568; padding: 20px;">ğŸ”„ Cargando registros desde Firebase...</p>';

            try {
                const result = await attendanceService.getAttendanceByDate(
                    currentUser.school_id, 
                    '2020-01-01', 
                    '2030-12-31', 
                    'individual'
                );

                if (!result.success) {
                    container.innerHTML = '<p style="text-align: center; color: #f56565; padding: 20px;">âŒ Error cargando registros de Firebase</p>';
                    return;
                }

                const records = result.data;

                if (records.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #4a5568; padding: 20px;">ğŸ“­ No hay registros disponibles en Firebase</p>';
                    return;
                }

                // Agrupar por estudiante
                const studentGroups = {};
                records.forEach(record => {
                    if (!studentGroups[record.student_id]) {
                        studentGroups[record.student_id] = {
                            name: record.student_name,
                            records: []
                        };
                    }
                    studentGroups[record.student_id].records.push(record);
                });

                container.innerHTML = Object.entries(studentGroups).map(([studentId, data]) => `
                    <div style="background: #f7fafc; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                        <h4 style="margin: 0 0 10px 0; color: #2d3748;">ğŸ‘¤ ${data.name} (ID: ${studentId})</h4>
                        <div style="font-size: 12px; color: #4a5568;">ğŸ“Š Total de registros en Firebase: ${data.records.length}</div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 8px; margin-top: 10px;">
                            ${data.records.slice(-5).map(record => `
                                <div style="background: white; padding: 8px; border-radius: 4px; font-size: 11px;">
                                    <div><strong>ğŸ“… ${record.date}</strong></div>
                                    <div class="status-badge status-${record.status}" style="margin-top: 4px; display: inline-block;">
                                        ${getStatusText(record.status)}
                                    </div>
                                    <div style="font-size: 9px; color: #718096; margin-top: 2px;">ğŸ”¥ ${record.id}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `).join('');

            } catch (error) {
                console.error('Error loading all records:', error);
                container.innerHTML = '<p style="text-align: center; color: #f56565; padding: 20px;">âŒ Error cargando registros de Firebase</p>';
            }
        }

        function getStatusText(status) {
            const statusMap = {
                presente: 'Presente',
                ausente: 'Ausente',
                tardanza: 'Tardanza',
                justificado: 'Justificado'
            };
            return statusMap[status] || status;
        }

        function showLoading(elementId, show) {
            const element = document.getElementById(elementId);
            if (element) {
                element.style.display = show ? 'block' : 'none';
            }
        }

        function showError(elementId, message) {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = message;
                element.style.display = 'block';
                setTimeout(() => {
                    element.style.display = 'none';
                }, 8000);
            }
        }

        function showSuccess(elementId, message) {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = message;
                element.style.display = 'block';
                setTimeout(() => {
                    element.style.display = 'none';
                }, 5000);
            } else {
                console.warn(`Elemento ${elementId} no encontrado para mostrar Ã©xito:`, message);
            }
        }

        // FunciÃ³n para probar Firebase manualmente
        async function testFirebaseManually() {
            const debugInfo = document.getElementById('debug-info');
            debugInfo.innerHTML = 'ğŸ”„ Probando conexiÃ³n...';

            try {
                // Verificar que Firebase estÃ© disponible
                if (!window.firebaseDb) {
                    throw new Error('window.firebaseDb no estÃ¡ disponible');
                }
                if (!window.firebaseModules) {
                    throw new Error('window.firebaseModules no estÃ¡ disponible');
                }

                // Intentar crear un documento de prueba
                const testData = {
                    test: true,
                    timestamp: new Date().toISOString(),
                    school_id: 'test-school',
                    message: 'Prueba manual de conexiÃ³n'
                };

                console.log('ğŸ§ª Creando documento de prueba:', testData);

                const docRef = await window.firebaseModules.addDoc(
                    window.firebaseModules.collection(window.firebaseDb, 'manual_test'), 
                    testData
                );

                debugInfo.innerHTML = `
                    âœ… <strong>ConexiÃ³n exitosa!</strong><br>
                    ğŸ“„ Documento creado: ${docRef.id}<br>
                    ğŸ—ï¸ Proyecto: base-de-datos-san-ignacio<br>
                    ğŸ”— Firebase SDK: Cargado correctamente
                `;

                updateFirebaseStatus('connected', 'âœ… Firebase funcionando correctamente');

            } catch (error) {
                console.error('âŒ Error en prueba manual:', error);
                debugInfo.innerHTML = `
                    âŒ <strong>Error de conexiÃ³n:</strong><br>
                    ğŸš¨ ${error.message}<br>
                    ğŸ” CÃ³digo: ${error.code || 'N/A'}<br>
                    ğŸ“Š Firebase DB: ${window.firebaseDb ? 'Disponible' : 'No disponible'}<br>
                    ğŸ› ï¸ MÃ³dulos: ${window.firebaseModules ? 'Disponible' : 'No disponible'}
                `;

                updateFirebaseStatus('error', 'âŒ Error de conexiÃ³n a Firebase');
            }
        }

        // FunciÃ³n para probar guardado de asistencia
        async function testAttendanceSave() {
            const debugInfo = document.getElementById('debug-info');
            debugInfo.innerHTML = 'ğŸ”„ Probando guardado de asistencia...';

            try {
                if (!attendanceService) {
                    throw new Error('AttendanceService no estÃ¡ inicializado');
                }

                // Datos de prueba
                const testAttendance = {
                    student_name: 'Estudiante de Prueba',
                    student_id: 'TEST-001',
                    date: new Date().toISOString().split('T')[0],
                    status: 'presente',
                    teacher_id: 'test-teacher',
                    teacher_name: 'Profesor de Prueba',
                    school_id: 'colegio-san-ignacio-123',
                    notes: 'Prueba de guardado desde diagnÃ³stico'
                };

                console.log('ğŸ’¾ Probando guardado con datos:', testAttendance);

                const result = await attendanceService.createIndividualAttendance(testAttendance);

                if (result.success) {
                    debugInfo.innerHTML = `
                        âœ… <strong>Guardado exitoso!</strong><br>
                        ğŸ“„ ID del documento: ${result.id}<br>
                        ğŸ‘¤ Estudiante: ${testAttendance.student_name}<br>
                        ğŸ“… Fecha: ${testAttendance.date}<br>
                        âœ… Estado: ${testAttendance.status}
                    `;
                    updateFirebaseStatus('connected', 'âœ… Guardado de asistencia funcionando');
                } else {
                    throw new Error(result.error);
                }

            } catch (error) {
                console.error('âŒ Error en prueba de guardado:', error);
                debugInfo.innerHTML = `
                    âŒ <strong>Error de guardado:</strong><br>
                    ğŸš¨ ${error.message}<br>
                    ğŸ” AttendanceService: ${attendanceService ? 'Disponible' : 'No disponible'}<br>
                    ğŸ“Š Firebase DB: ${window.firebaseDb ? 'Disponible' : 'No disponible'}<br>
                    ğŸ› ï¸ MÃ³dulos: ${window.firebaseModules ? 'Disponible' : 'No disponible'}
                `;
                updateFirebaseStatus('error', 'âŒ Error en guardado de asistencia');
            }
        }

        // Actualizar informaciÃ³n de diagnÃ³stico al cargar
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                const debugInfo = document.getElementById('debug-info');
                debugInfo.innerHTML = `
                    ğŸ“Š Firebase DB: ${window.firebaseDb ? 'âœ… Disponible' : 'âŒ No disponible'}<br>
                    ğŸ› ï¸ MÃ³dulos: ${window.firebaseModules ? 'âœ… Disponible' : 'âŒ No disponible'}<br>
                    ğŸ—ï¸ Proyecto: base-de-datos-san-ignacio<br>
                    ğŸ‘¤ Usuario: ${currentUser ? currentUser.name : 'No configurado'}
                `;
            }, 1000);
        });
    </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'996dc5f3b6dba64c',t:'MTc2MTg1NzMwMy4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
