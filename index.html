<!doctype html>
<html lang="es">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistema de Asistencia Escolar</title>
  <script src="/_sdk/data_sdk.js"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
        body {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100%;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
            padding: 10px;
            min-height: 100%;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            color: #2d3748;
            margin: 0 0 10px 0;
            font-size: 24px;
            font-weight: 700;
        }

        .header p {
            color: #4a5568;
            margin: 0;
            font-size: 14px;
        }

        .login-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .user-type-selector {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }

        .user-type-btn {
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            background: white;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .user-type-btn.active {
            background: #4299e1;
            color: white;
            border-color: #4299e1;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #2d3748;
            font-weight: 600;
            font-size: 14px;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
            box-sizing: border-box;
        }

        .form-group input:focus {
            outline: none;
            border-color: #4299e1;
        }

        .btn {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 10px;
        }

        .btn-primary {
            background: #4299e1;
            color: white;
        }

        .btn-primary:hover {
            background: #3182ce;
        }

        .btn-success {
            background: #48bb78;
            color: white;
        }

        .btn-success:hover {
            background: #38a169;
        }

        .btn-warning {
            background: #ed8936;
            color: white;
        }

        .btn-warning:hover {
            background: #dd6b20;
        }

        .btn-danger {
            background: #f56565;
            color: white;
        }

        .btn-danger:hover {
            background: #e53e3e;
        }

        .btn-secondary {
            background: #a0aec0;
            color: white;
        }

        .btn-secondary:hover {
            background: #718096;
        }

        .main-app {
            display: none;
        }

        .nav-tabs {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 5px;
            margin-bottom: 20px;
            background: rgba(255, 255, 255, 0.1);
            padding: 5px;
            border-radius: 12px;
        }

        .nav-tab {
            padding: 10px;
            text-align: center;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: white;
            font-weight: 600;
            font-size: 14px;
        }

        .nav-tab.active {
            background: rgba(255, 255, 255, 0.9);
            color: #2d3748;
        }

        .tab-content {
            display: none;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .tab-content.active {
            display: block;
        }

        .student-form {
            display: grid;
            gap: 15px;
            margin-bottom: 20px;
        }

        .attendance-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            gap: 8px;
            margin-top: 10px;
        }

        .attendance-btn {
            padding: 8px;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .attendance-list {
            max-height: 400px;
            overflow-y: auto;
            margin-top: 20px;
        }

        .attendance-item {
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 10px;
            align-items: center;
        }

        .attendance-info h4 {
            margin: 0 0 5px 0;
            color: #2d3748;
            font-size: 14px;
        }

        .attendance-info p {
            margin: 0;
            color: #4a5568;
            font-size: 12px;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-align: center;
        }

        .status-presente {
            background: #c6f6d5;
            color: #22543d;
        }

        .status-ausente {
            background: #fed7d7;
            color: #742a2a;
        }

        .status-tardanza {
            background: #feebc8;
            color: #7b341e;
        }

        .status-justificado {
            background: #bee3f8;
            color: #2a4365;
        }

        .user-info {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            color: white;
            text-align: center;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #4a5568;
        }

        .spinner {
            border: 3px solid #e2e8f0;
            border-top: 3px solid #4299e1;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            background: #fed7d7;
            color: #742a2a;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: none;
        }

        .success-message {
            background: #c6f6d5;
            color: #22543d;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: none;
        }

        @media (max-width: 480px) {
            .container {
                padding: 5px;
            }
            
            .header h1 {
                font-size: 20px;
            }
            
            .attendance-grid {
                grid-template-columns: 1fr 1fr;
                gap: 5px;
            }
            
            .attendance-btn {
                padding: 6px;
                font-size: 11px;
            }
            
            .nav-tabs {
                grid-template-columns: 1fr;
                gap: 2px;
            }
            
            .nav-tab {
                font-size: 12px;
                padding: 8px;
            }
        }
    </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
 </head>
 <body>
  <main class="container">
   <header class="header">
    <h1 id="school-name">Sistema de Asistencia Escolar</h1>
    <p id="academic-year">A√±o Acad√©mico 2024-2025</p>
   </header><!-- Secci√≥n de Login -->
   <section id="login-section" class="login-section">
    <h2 style="text-align: center; color: #2d3748; margin-bottom: 20px;">Iniciar Sesi√≥n</h2>
    <div class="user-type-selector">
     <div class="user-type-btn active" data-type="teacher">
      üë®‚Äçüè´ Docente
     </div>
     <div class="user-type-btn" data-type="director">
      üë®‚Äçüíº Director
     </div>
    </div>
    <div class="error-message" id="login-error"></div>
    <form id="login-form">
     <div class="form-group"><label for="username">Usuario:</label> <input type="text" id="username" name="username" required>
     </div>
     <div class="form-group"><label for="password">Contrase√±a:</label> <input type="password" id="password" name="password" required>
     </div><button type="submit" class="btn btn-primary">Ingresar</button>
    </form>
    <div style="margin-top: 20px; padding: 15px; background: #f7fafc; border-radius: 8px; font-size: 12px; color: #4a5568;"><strong>Credenciales de prueba:</strong><br>
      üë®‚Äçüè´ Docente: usuario: <code>docente</code> / contrase√±a: <code>123</code><br>
      üë®‚Äçüíº Director: usuario: <code>director</code> / contrase√±a: <code>admin</code>
    </div>
   </section><!-- Aplicaci√≥n Principal -->
   <section id="main-app" class="main-app">
    <div class="user-info">
     <h3 id="user-welcome">Bienvenido</h3>
     <p id="user-role"></p><button class="btn btn-secondary" onclick="logout()">Cerrar Sesi√≥n</button>
    </div>
    <nav class="nav-tabs">
     <div class="nav-tab active" data-tab="attendance">
      üìù Individual
     </div>
     <div class="nav-tab" data-tab="classroom">
      üè´ Por Aula
     </div>
     <div class="nav-tab" data-tab="reports">
      üìä Reportes
     </div>
     <div class="nav-tab" data-tab="students" id="students-tab" style="display: none;">
      üë• Estudiantes
     </div>
    </nav><!-- Tab de Asistencia Individual -->
    <div id="attendance-tab" class="tab-content active">
     <h3>Registro de Asistencia</h3>
     <div class="success-message" id="attendance-success"></div>
     <div class="error-message" id="attendance-error"></div>
     <div class="loading" id="attendance-loading">
      <div class="spinner"></div> Guardando asistencia...
     </div>
     <form id="attendance-form" class="student-form">
      <div class="form-group"><label for="student-name">Nombre del Estudiante:</label> <input type="text" id="student-name" name="student-name" required>
      </div>
      <div class="form-group"><label for="student-id">ID del Estudiante:</label> <input type="text" id="student-id" name="student-id" required>
      </div>
      <div class="form-group"><label for="attendance-date">Fecha:</label> <input type="date" id="attendance-date" name="attendance-date" required>
      </div>
      <div class="form-group"><label for="notes">Notas (opcional):</label> <input type="text" id="notes" name="notes" placeholder="Observaciones adicionales...">
      </div>
      <div class="attendance-grid"><button type="button" class="attendance-btn btn-success" data-status="presente"> ‚úÖ Presente </button> <button type="button" class="attendance-btn btn-danger" data-status="ausente"> ‚ùå Ausente </button> <button type="button" class="attendance-btn btn-warning" data-status="tardanza"> ‚è∞ Tardanza </button> <button type="button" class="attendance-btn btn-secondary" data-status="justificado"> üìã Justificado </button>
      </div>
     </form>
     <div class="attendance-list" id="attendance-list">
      <h4>Registros de Hoy</h4>
      <div id="today-records"></div>
     </div>
    </div><!-- Tab de Asistencia por Aula -->
    <div id="classroom-tab" class="tab-content">
     <h3>Asistencia por Aula</h3>
     <div class="success-message" id="classroom-success"></div>
     <div class="error-message" id="classroom-error"></div>
     <div class="loading" id="classroom-loading">
      <div class="spinner"></div> Guardando datos del aula...
     </div>
     <form id="classroom-form" class="student-form">
      <div class="form-group"><label for="classroom-grade">Grado:</label> <select id="classroom-grade" name="classroom-grade" required> <option value="">Seleccionar grado</option> <option value="7mo">7mo Grado</option> <option value="8vo">8vo Grado</option> <option value="9no">9no Grado</option> <option value="10mo">10mo Grado</option> <option value="11vo">11vo Grado</option> </select>
      </div>
      <div class="form-group"><label for="classroom-section">Secci√≥n:</label> <select id="classroom-section" name="classroom-section" required> <option value="">Seleccionar secci√≥n</option> <option value="A">Secci√≥n A</option> <option value="B">Secci√≥n B</option> <option value="C">Secci√≥n C</option> <option value="D">Secci√≥n D</option> </select>
      </div>
      <div class="form-group"><label for="classroom-date">Fecha:</label> <input type="date" id="classroom-date" name="classroom-date" required>
      </div>
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 20px 0;">
       <div class="form-group"><label for="male-present">üë¶ Varones Presentes:</label> <input type="number" id="male-present" name="male-present" min="0" value="0" required>
       </div>
       <div class="form-group"><label for="female-present">üëß Mujeres Presentes:</label> <input type="number" id="female-present" name="female-present" min="0" value="0" required>
       </div>
      </div>
      <div class="form-group"><label for="total-absent">‚ùå Total de Ausentes:</label> <input type="number" id="total-absent" name="total-absent" min="0" value="0" required>
      </div>
      <div class="form-group"><label for="total-enrolled">üë• Total Matriculados en el Aula:</label> <input type="number" id="total-enrolled" name="total-enrolled" min="1" required>
      </div>
      <div class="form-group"><label for="classroom-notes">Observaciones (opcional):</label> <input type="text" id="classroom-notes" name="classroom-notes" placeholder="Notas adicionales sobre el aula...">
      </div><button type="submit" class="btn btn-primary">üíæ Guardar Asistencia del Aula</button>
     </form>
     <div class="attendance-list" id="classroom-list">
      <h4>Registros de Aulas de Hoy</h4>
      <div id="today-classroom-records"></div>
     </div>
    </div><!-- Tab de Reportes -->
    <div id="reports-tab" class="tab-content">
     <h3>Generar Reportes</h3>
     <div class="success-message" id="report-success"></div>
     <div class="error-message" id="report-error"></div>
     <div class="loading" id="report-loading">
      <div class="spinner"></div> Generando reporte...
     </div>
     <div class="form-group"><label for="report-start-date">Fecha de Inicio:</label> <input type="date" id="report-start-date">
     </div>
     <div class="form-group"><label for="report-end-date">Fecha de Fin:</label> <input type="date" id="report-end-date">
     </div><button class="btn btn-success" onclick="generateExcelReport()"> üìä Generar Reporte Excel </button>
     <div id="report-summary" style="margin-top: 20px;"></div>
    </div><!-- Tab de Estudiantes (Solo Director) -->
    <div id="students-tab-content" class="tab-content">
     <h3>Gesti√≥n de Estudiantes</h3>
     <p>Funcionalidad disponible solo para directores</p>
     <div id="all-records"></div>
    </div>
   </section>
  </main>
  <script>
        // Variables globales
        let currentUser = null;
        let currentUserType = 'teacher';
        let attendanceRecords = [];
        let selectedStatus = null;

        // Configuraci√≥n por defecto
        const defaultConfig = {
            school_name: "Sistema de Asistencia Escolar",
            director_name: "Director(a)",
            academic_year: "2024-2025"
        };

        // Credenciales de prueba (en producci√≥n esto estar√≠a en Firebase Auth)
        const credentials = {
            teacher: { username: 'docente', password: '123', name: 'Prof. Mar√≠a Garc√≠a' },
            director: { username: 'director', password: 'admin', name: 'Dr. Juan P√©rez' }
        };

        // Handler para el Data SDK
        const dataHandler = {
            onDataChanged(data) {
                attendanceRecords = data;
                updateAttendanceDisplay();
                updateClassroomDisplay();
                updateReportSummary();
            }
        };

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', async function() {
            // Inicializar Data SDK
            const initResult = await window.dataSdk.init(dataHandler);
            if (!initResult.isOk) {
                console.error('Error inicializando Data SDK');
                return;
            }

            // Inicializar Element SDK
            if (window.elementSdk) {
                await window.elementSdk.init({
                    defaultConfig,
                    onConfigChange: async (config) => {
                        document.getElementById('school-name').textContent = 
                            config.school_name || defaultConfig.school_name;
                        document.getElementById('academic-year').textContent = 
                            `A√±o Acad√©mico ${config.academic_year || defaultConfig.academic_year}`;
                    },
                    mapToCapabilities: (config) => ({
                        recolorables: [],
                        borderables: [],
                        fontEditable: undefined,
                        fontSizeable: undefined
                    }),
                    mapToEditPanelValues: (config) => new Map([
                        ['school_name', config.school_name || defaultConfig.school_name],
                        ['director_name', config.director_name || defaultConfig.director_name],
                        ['academic_year', config.academic_year || defaultConfig.academic_year]
                    ])
                });
            }

            setupEventListeners();
            setTodayDate();
        });

        function setupEventListeners() {
            // Selector de tipo de usuario
            document.querySelectorAll('.user-type-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.user-type-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentUserType = this.dataset.type;
                });
            });

            // Form de login
            document.getElementById('login-form').addEventListener('submit', handleLogin);

            // Tabs de navegaci√≥n
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabName = this.dataset.tab;
                    switchTab(tabName);
                });
            });

            // Botones de asistencia
            document.querySelectorAll('.attendance-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    selectAttendanceStatus(this.dataset.status);
                });
            });

            // Form de asistencia
            document.getElementById('attendance-form').addEventListener('submit', handleAttendanceSubmit);

            // Form de asistencia por aula
            document.getElementById('classroom-form').addEventListener('submit', handleClassroomSubmit);
        }

        function setTodayDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('attendance-date').value = today;
            document.getElementById('classroom-date').value = today;
            document.getElementById('report-start-date').value = today;
            document.getElementById('report-end-date').value = today;
        }

        async function handleLogin(e) {
            e.preventDefault();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('login-error');

            // Validar credenciales
            const userCreds = credentials[currentUserType];
            if (username === userCreds.username && password === userCreds.password) {
                currentUser = {
                    name: userCreds.name,
                    type: currentUserType,
                    username: username
                };

                // Mostrar aplicaci√≥n principal
                document.getElementById('login-section').style.display = 'none';
                document.getElementById('main-app').style.display = 'block';

                // Configurar interfaz seg√∫n tipo de usuario
                setupUserInterface();
                
                errorDiv.style.display = 'none';
            } else {
                errorDiv.textContent = 'Credenciales incorrectas. Verifica tu usuario y contrase√±a.';
                errorDiv.style.display = 'block';
            }
        }

        function setupUserInterface() {
            document.getElementById('user-welcome').textContent = `Bienvenido, ${currentUser.name}`;
            document.getElementById('user-role').textContent = 
                currentUser.type === 'director' ? 'Director de la Instituci√≥n' : 'Docente';

            // Mostrar tab de estudiantes solo para directores
            if (currentUser.type === 'director') {
                document.getElementById('students-tab').style.display = 'block';
            }
        }

        function logout() {
            currentUser = null;
            document.getElementById('login-section').style.display = 'block';
            document.getElementById('main-app').style.display = 'none';
            document.getElementById('login-form').reset();
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
        }

        function switchTab(tabName) {
            // Actualizar tabs activos
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

            // Mostrar contenido correspondiente
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`${tabName}-tab`).classList.add('active');

            // Cargar datos espec√≠ficos del tab
            if (tabName === 'students' && currentUser.type === 'director') {
                loadAllRecords();
            }
        }

        function selectAttendanceStatus(status) {
            selectedStatus = status;
            
            // Actualizar botones
            document.querySelectorAll('.attendance-btn').forEach(btn => {
                btn.style.opacity = btn.dataset.status === status ? '1' : '0.5';
                btn.style.transform = btn.dataset.status === status ? 'scale(1.05)' : 'scale(1)';
            });
        }

        async function handleAttendanceSubmit(e) {
            e.preventDefault();

            if (!selectedStatus) {
                showError('attendance-error', 'Por favor selecciona un estado de asistencia');
                return;
            }

            if (attendanceRecords.length >= 999) {
                showError('attendance-error', 'Se ha alcanzado el l√≠mite m√°ximo de 999 registros. Por favor elimina algunos registros primero.');
                return;
            }

            const formData = new FormData(e.target);
            const studentName = formData.get('student-name');
            const studentId = formData.get('student-id');
            const date = formData.get('attendance-date');
            const notes = formData.get('notes') || '';

            showLoading('attendance-loading', true);

            const attendanceRecord = {
                id: `${studentId}-${date}-${Date.now()}`,
                type: 'individual',
                student_name: studentName,
                student_id: studentId,
                date: date,
                status: selectedStatus,
                teacher: currentUser.name,
                notes: notes,
                timestamp: new Date().toISOString()
            };

            const result = await window.dataSdk.create(attendanceRecord);
            
            showLoading('attendance-loading', false);

            if (result.isOk) {
                showSuccess('attendance-success', `Asistencia registrada correctamente para ${studentName}`);
                e.target.reset();
                setTodayDate();
                selectedStatus = null;
                
                // Resetear botones
                document.querySelectorAll('.attendance-btn').forEach(btn => {
                    btn.style.opacity = '1';
                    btn.style.transform = 'scale(1)';
                });
            } else {
                showError('attendance-error', 'Error al guardar la asistencia. Int√©ntalo de nuevo.');
            }
        }

        async function handleClassroomSubmit(e) {
            e.preventDefault();

            if (attendanceRecords.length >= 999) {
                showError('classroom-error', 'Se ha alcanzado el l√≠mite m√°ximo de 999 registros. Por favor elimina algunos registros primero.');
                return;
            }

            const formData = new FormData(e.target);
            const grade = formData.get('classroom-grade');
            const section = formData.get('classroom-section');
            const date = formData.get('classroom-date');
            const malePresent = parseInt(formData.get('male-present')) || 0;
            const femalePresent = parseInt(formData.get('female-present')) || 0;
            const totalAbsent = parseInt(formData.get('total-absent')) || 0;
            const totalEnrolled = parseInt(formData.get('total-enrolled')) || 0;
            const notes = formData.get('classroom-notes') || '';

            // Validaciones
            const totalPresent = malePresent + femalePresent;
            if (totalPresent + totalAbsent !== totalEnrolled) {
                showError('classroom-error', `Error: Los presentes (${totalPresent}) + ausentes (${totalAbsent}) deben sumar el total matriculado (${totalEnrolled})`);
                return;
            }

            showLoading('classroom-loading', true);

            const classroomRecord = {
                id: `${grade}-${section}-${date}`,
                type: 'classroom',
                grade: grade,
                section: section,
                date: date,
                male_count: malePresent,
                female_count: femalePresent,
                absent_count: totalAbsent,
                total_enrolled: totalEnrolled,
                teacher: currentUser.name,
                notes: notes,
                timestamp: new Date().toISOString()
            };

            const result = await window.dataSdk.create(classroomRecord);
            
            showLoading('classroom-loading', false);

            if (result.isOk) {
                showSuccess('classroom-success', `Asistencia registrada para ${grade} ${section}: ${totalPresent} presentes, ${totalAbsent} ausentes`);
                e.target.reset();
                setTodayDate();
            } else {
                showError('classroom-error', 'Error al guardar la asistencia del aula. Int√©ntalo de nuevo.');
            }
        }

        function updateAttendanceDisplay() {
            const today = new Date().toISOString().split('T')[0];
            const todayRecords = attendanceRecords.filter(record => 
                record.date === today && record.type !== 'classroom'
            );
            
            const container = document.getElementById('today-records');
            
            if (todayRecords.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #4a5568; padding: 20px;">No hay registros individuales para hoy</p>';
                return;
            }

            container.innerHTML = todayRecords.map(record => `
                <div class="attendance-item">
                    <div class="attendance-info">
                        <h4>${record.student_name} (ID: ${record.student_id})</h4>
                        <p>Docente: ${record.teacher}</p>
                        ${record.notes ? `<p>Notas: ${record.notes}</p>` : ''}
                    </div>
                    <div class="status-badge status-${record.status}">
                        ${getStatusText(record.status)}
                    </div>
                </div>
            `).join('');
        }

        function updateClassroomDisplay() {
            const today = new Date().toISOString().split('T')[0];
            const todayClassrooms = attendanceRecords.filter(record => 
                record.date === today && record.type === 'classroom'
            );
            
            const container = document.getElementById('today-classroom-records');
            
            if (todayClassrooms.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #4a5568; padding: 20px;">No hay registros de aulas para hoy</p>';
                return;
            }

            container.innerHTML = todayClassrooms.map(record => `
                <div class="attendance-item">
                    <div class="attendance-info">
                        <h4>${record.grade} - Secci√≥n ${record.section}</h4>
                        <p>üë¶ Varones: ${record.male_count} | üëß Mujeres: ${record.female_count}</p>
                        <p>‚ùå Ausentes: ${record.absent_count} | üë• Total: ${record.total_enrolled}</p>
                        <p>Docente: ${record.teacher}</p>
                        ${record.notes ? `<p>Notas: ${record.notes}</p>` : ''}
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 24px; font-weight: bold; color: #48bb78;">
                            ${record.male_count + record.female_count}
                        </div>
                        <div style="font-size: 12px; color: #4a5568;">Presentes</div>
                    </div>
                </div>
            `).join('');
        }

        function getStatusText(status) {
            const statusMap = {
                presente: 'Presente',
                ausente: 'Ausente',
                tardanza: 'Tardanza',
                justificado: 'Justificado'
            };
            return statusMap[status] || status;
        }

        async function generateExcelReport() {
            const startDate = document.getElementById('report-start-date').value;
            const endDate = document.getElementById('report-end-date').value;

            if (!startDate || !endDate) {
                showError('report-error', 'Por favor selecciona las fechas de inicio y fin');
                return;
            }

            showLoading('report-loading', true);

            // Filtrar registros por fecha
            const filteredRecords = attendanceRecords.filter(record => {
                return record.date >= startDate && record.date <= endDate;
            });

            if (filteredRecords.length === 0) {
                showLoading('report-loading', false);
                showError('report-error', 'No hay registros en el rango de fechas seleccionado');
                return;
            }

            // Separar registros individuales y de aula
            const individualRecords = filteredRecords.filter(record => record.type !== 'classroom');
            const classroomRecords = filteredRecords.filter(record => record.type === 'classroom');

            // Preparar datos para Excel - Registros Individuales
            const individualData = individualRecords.map(record => ({
                'Fecha': record.date,
                'Nombre del Estudiante': record.student_name,
                'ID Estudiante': record.student_id,
                'Estado': getStatusText(record.status),
                'Docente': record.teacher,
                'Notas': record.notes || '',
                'Hora de Registro': new Date(record.timestamp).toLocaleString('es-ES')
            }));

            // Preparar datos para Excel - Registros por Aula
            const classroomData = classroomRecords.map(record => ({
                'Fecha': record.date,
                'Grado': record.grade,
                'Secci√≥n': record.section,
                'Varones Presentes': record.male_count,
                'Mujeres Presentes': record.female_count,
                'Total Presentes': record.male_count + record.female_count,
                'Total Ausentes': record.absent_count,
                'Total Matriculados': record.total_enrolled,
                'Docente': record.teacher,
                'Notas': record.notes || '',
                'Hora de Registro': new Date(record.timestamp).toLocaleString('es-ES')
            }));

            // Crear libro de Excel
            const wb = XLSX.utils.book_new();

            // Hoja de registros individuales
            if (individualData.length > 0) {
                const wsIndividual = XLSX.utils.json_to_sheet(individualData);
                const colWidthsIndividual = [
                    { wch: 12 }, // Fecha
                    { wch: 25 }, // Nombre
                    { wch: 15 }, // ID
                    { wch: 12 }, // Estado
                    { wch: 20 }, // Docente
                    { wch: 30 }, // Notas
                    { wch: 20 }  // Hora
                ];
                wsIndividual['!cols'] = colWidthsIndividual;
                XLSX.utils.book_append_sheet(wb, wsIndividual, 'Asistencia Individual');
            }

            // Hoja de registros por aula
            if (classroomData.length > 0) {
                const wsClassroom = XLSX.utils.json_to_sheet(classroomData);
                const colWidthsClassroom = [
                    { wch: 12 }, // Fecha
                    { wch: 10 }, // Grado
                    { wch: 10 }, // Secci√≥n
                    { wch: 15 }, // Varones
                    { wch: 15 }, // Mujeres
                    { wch: 15 }, // Total Presentes
                    { wch: 15 }, // Ausentes
                    { wch: 15 }, // Matriculados
                    { wch: 20 }, // Docente
                    { wch: 30 }, // Notas
                    { wch: 20 }  // Hora
                ];
                wsClassroom['!cols'] = colWidthsClassroom;
                XLSX.utils.book_append_sheet(wb, wsClassroom, 'Asistencia por Aula');
            }

            // Generar nombre de archivo
            const fileName = `Reporte_Asistencia_${startDate}_${endDate}.xlsx`;

            // Descargar archivo
            XLSX.writeFile(wb, fileName);

            showLoading('report-loading', false);
            showSuccess('report-success', `Reporte generado exitosamente: ${fileName}`);
        }

        function updateReportSummary() {
            const startDate = document.getElementById('report-start-date').value;
            const endDate = document.getElementById('report-end-date').value;

            if (!startDate || !endDate) return;

            const filteredRecords = attendanceRecords.filter(record => {
                return record.date >= startDate && record.date <= endDate;
            });

            // Separar registros individuales y de aula
            const individualRecords = filteredRecords.filter(record => record.type !== 'classroom');
            const classroomRecords = filteredRecords.filter(record => record.type === 'classroom');

            // Resumen individual
            const individualSummary = {
                total: individualRecords.length,
                presente: individualRecords.filter(r => r.status === 'presente').length,
                ausente: individualRecords.filter(r => r.status === 'ausente').length,
                tardanza: individualRecords.filter(r => r.status === 'tardanza').length,
                justificado: individualRecords.filter(r => r.status === 'justificado').length
            };

            // Resumen por aula
            const classroomSummary = {
                totalAulas: classroomRecords.length,
                totalVarones: classroomRecords.reduce((sum, r) => sum + (r.male_count || 0), 0),
                totalMujeres: classroomRecords.reduce((sum, r) => sum + (r.female_count || 0), 0),
                totalAusentes: classroomRecords.reduce((sum, r) => sum + (r.absent_count || 0), 0),
                totalMatriculados: classroomRecords.reduce((sum, r) => sum + (r.total_enrolled || 0), 0)
            };

            const summaryContainer = document.getElementById('report-summary');
            summaryContainer.innerHTML = `
                <div style="background: #f7fafc; padding: 15px; border-radius: 8px; margin-top: 15px;">
                    <h4 style="margin: 0 0 15px 0; color: #2d3748;">üìä Resumen del Per√≠odo</h4>
                    
                    ${individualRecords.length > 0 ? `
                    <div style="margin-bottom: 20px;">
                        <h5 style="margin: 0 0 10px 0; color: #4a5568;">üë§ Asistencia Individual</h5>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 8px;">
                            <div style="text-align: center; padding: 8px; background: white; border-radius: 6px;">
                                <div style="font-size: 18px; font-weight: bold; color: #2d3748;">${individualSummary.total}</div>
                                <div style="font-size: 11px; color: #4a5568;">Total</div>
                            </div>
                            <div style="text-align: center; padding: 8px; background: #c6f6d5; border-radius: 6px;">
                                <div style="font-size: 18px; font-weight: bold; color: #22543d;">${individualSummary.presente}</div>
                                <div style="font-size: 11px; color: #22543d;">Presentes</div>
                            </div>
                            <div style="text-align: center; padding: 8px; background: #fed7d7; border-radius: 6px;">
                                <div style="font-size: 18px; font-weight: bold; color: #742a2a;">${individualSummary.ausente}</div>
                                <div style="font-size: 11px; color: #742a2a;">Ausentes</div>
                            </div>
                            <div style="text-align: center; padding: 8px; background: #feebc8; border-radius: 6px;">
                                <div style="font-size: 18px; font-weight: bold; color: #7b341e;">${individualSummary.tardanza}</div>
                                <div style="font-size: 11px; color: #7b341e;">Tardanzas</div>
                            </div>
                        </div>
                    </div>
                    ` : ''}
                    
                    ${classroomRecords.length > 0 ? `
                    <div>
                        <h5 style="margin: 0 0 10px 0; color: #4a5568;">üè´ Asistencia por Aula</h5>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 8px;">
                            <div style="text-align: center; padding: 8px; background: white; border-radius: 6px;">
                                <div style="font-size: 18px; font-weight: bold; color: #2d3748;">${classroomSummary.totalAulas}</div>
                                <div style="font-size: 11px; color: #4a5568;">Aulas</div>
                            </div>
                            <div style="text-align: center; padding: 8px; background: #bee3f8; border-radius: 6px;">
                                <div style="font-size: 18px; font-weight: bold; color: #2a4365;">${classroomSummary.totalVarones}</div>
                                <div style="font-size: 11px; color: #2a4365;">üë¶ Varones</div>
                            </div>
                            <div style="text-align: center; padding: 8px; background: #fbb6ce; border-radius: 6px;">
                                <div style="font-size: 18px; font-weight: bold; color: #97266d;">${classroomSummary.totalMujeres}</div>
                                <div style="font-size: 11px; color: #97266d;">üëß Mujeres</div>
                            </div>
                            <div style="text-align: center; padding: 8px; background: #fed7d7; border-radius: 6px;">
                                <div style="font-size: 18px; font-weight: bold; color: #742a2a;">${classroomSummary.totalAusentes}</div>
                                <div style="font-size: 11px; color: #742a2a;">‚ùå Ausentes</div>
                            </div>
                            <div style="text-align: center; padding: 8px; background: #c6f6d5; border-radius: 6px;">
                                <div style="font-size: 18px; font-weight: bold; color: #22543d;">${classroomSummary.totalVarones + classroomSummary.totalMujeres}</div>
                                <div style="font-size: 11px; color: #22543d;">‚úÖ Presentes</div>
                            </div>
                        </div>
                    </div>
                    ` : ''}
                    
                    ${filteredRecords.length === 0 ? '<p style="text-align: center; color: #4a5568; margin: 0;">No hay registros en el per√≠odo seleccionado</p>' : ''}
                </div>
            `;
        }

        function loadAllRecords() {
            const container = document.getElementById('all-records');
            
            if (attendanceRecords.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #4a5568; padding: 20px;">No hay registros disponibles</p>';
                return;
            }

            // Agrupar por estudiante
            const studentGroups = {};
            attendanceRecords.forEach(record => {
                if (!studentGroups[record.student_id]) {
                    studentGroups[record.student_id] = {
                        name: record.student_name,
                        records: []
                    };
                }
                studentGroups[record.student_id].records.push(record);
            });

            container.innerHTML = Object.entries(studentGroups).map(([studentId, data]) => `
                <div style="background: #f7fafc; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                    <h4 style="margin: 0 0 10px 0; color: #2d3748;">${data.name} (ID: ${studentId})</h4>
                    <div style="font-size: 12px; color: #4a5568;">Total de registros: ${data.records.length}</div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 8px; margin-top: 10px;">
                        ${data.records.slice(-5).map(record => `
                            <div style="background: white; padding: 8px; border-radius: 4px; font-size: 11px;">
                                <div><strong>${record.date}</strong></div>
                                <div class="status-badge status-${record.status}" style="margin-top: 4px; display: inline-block;">
                                    ${getStatusText(record.status)}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');
        }

        function showLoading(elementId, show) {
            document.getElementById(elementId).style.display = show ? 'block' : 'none';
        }

        function showError(elementId, message) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.style.display = 'block';
            setTimeout(() => {
                element.style.display = 'none';
            }, 5000);
        }

        function showSuccess(elementId, message) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.style.display = 'block';
            setTimeout(() => {
                element.style.display = 'none';
            }, 5000);
        }

        // Actualizar resumen cuando cambien las fechas
        document.getElementById('report-start-date').addEventListener('change', updateReportSummary);
        document.getElementById('report-end-date').addEventListener('change', updateReportSummary);
    </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'995ba630d49aa4d4',t:'MTc2MTY2NzI1OS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
