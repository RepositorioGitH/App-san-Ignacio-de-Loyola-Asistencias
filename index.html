<!doctype html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistema de Asistencia Escolar - Firebase</title>

  <!-- ‚úÖ Firebase SDK CORREGIDO -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { 
        getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged 
    } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    import { 
        getFirestore, collection, addDoc, query, where, orderBy, getDocs, doc, getDoc, serverTimestamp 
    } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    // ‚úÖ Configuraci√≥n Firebase corregida
    const firebaseConfig = {
        apiKey: "AIzaSyDjkCjj1iLMi3Z22o6cj1Xa-yYDoqjBm04",
        authDomain: "base-de-datos-san-ignacio.firebaseapp.com",
        projectId: "base-de-datos-san-ignacio",
        storageBucket: "base-de-datos-san-ignacio.appspot.com",
        messagingSenderId: "698408506523",
        appId: "1:698408506523:web:ede2c739a1920e8956a23e",
        measurementId: "G-Z16V5DDNB8"
    };

    // ‚úÖ Inicializar Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Exponer globalmente
    window.firebaseAuth = auth;
    window.firebaseDb = db;
    window.firebaseModules = {
        signInWithEmailAndPassword,
        signOut,
        onAuthStateChanged,
        collection,
        addDoc,
        query,
        where,
        orderBy,
        getDocs,
        doc,
        getDoc,
        serverTimestamp
    };

    console.log("‚úÖ Firebase inicializado correctamente");
  </script>

  <!-- Librer√≠a Excel -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css">

  <style>
    body {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }
    .container {
      max-width: 100%;
      margin: 0 auto;
      padding: 10px;
    }
    .header {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 20px;
      text-align: center;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    }
    .header h1 {
      color: #2d3748;
      margin: 0 0 10px 0;
      font-size: 24px;
      font-weight: 700;
    }
    .btn {
      width: 100%;
      padding: 12px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-bottom: 10px;
    }
    .btn-primary { background: #4299e1; color: white; }
    .btn-primary:hover { background: #3182ce; }
    .btn-success { background: #48bb78; color: white; }
    .btn-success:hover { background: #38a169; }
    .btn-danger { background: #f56565; color: white; }
    .btn-danger:hover { background: #e53e3e; }
    .form-group { margin-bottom: 15px; }
    .form-group label {
      display: block;
      margin-bottom: 5px;
      color: #2d3748;
      font-weight: 600;
      font-size: 14px;
    }
    .form-group input, .form-group select {
      width: 100%;
      padding: 12px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      font-size: 16px;
      transition: border-color 0.3s ease;
      box-sizing: border-box;
    }
    .form-group input:focus, .form-group select:focus {
      outline: none;
      border-color: #4299e1;
    }
    .success-message, .error-message {
      display: none;
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 15px;
      text-align: center;
    }
    .success-message { background: #c6f6d5; color: #22543d; }
    .error-message { background: #fed7d7; color: #742a2a; }
  </style>
</head>

<body>
  <main class="container">
    <header class="header">
      <h1>Sistema de Asistencia Escolar - Firebase</h1>
      <p>A√±o Acad√©mico 2025</p>
    </header>

    <div id="firebase-status" class="text-center text-white mb-4">‚úÖ Conectado a Firebase</div>

    <section id="main-app" class="bg-white bg-opacity-90 rounded-xl p-6 shadow-lg">
      <h3 class="text-xl font-bold mb-4">Registro de Asistencia Individual</h3>

      <div class="success-message" id="attendance-success"></div>
      <div class="error-message" id="attendance-error"></div>

      <form id="attendance-form">
        <div class="form-group">
          <label for="student-name">Nombre del Estudiante:</label>
          <input type="text" id="student-name" required>
        </div>
        <div class="form-group">
          <label for="student-id">ID del Estudiante:</label>
          <input type="text" id="student-id" required>
        </div>
        <div class="form-group">
          <label for="attendance-date">Fecha:</label>
          <input type="date" id="attendance-date" required>
        </div>
        <div class="form-group">
          <label for="notes">Notas (opcional):</label>
          <input type="text" id="notes" placeholder="Observaciones...">
        </div>

        <div class="grid grid-cols-2 gap-2 mb-4">
          <button type="button" class="btn btn-success" data-status="presente">‚úÖ Presente</button>
          <button type="button" class="btn btn-danger" data-status="ausente">‚ùå Ausente</button>
          <button type="button" class="btn btn-primary" data-status="tardanza">‚è∞ Tardanza</button>
          <button type="button" class="btn btn-primary" data-status="justificado">üìã Justificado</button>
        </div>

        <button type="submit" class="btn btn-primary">üíæ Guardar en Firebase</button>
      </form>
    </section>
  </main>

  <!-- Script principal -->
  <script>
    let selectedStatus = null;
    let currentUser = {
      uid: 'demo-user-123',
      name: 'Prof. Mar√≠a Garc√≠a',
      email: 'maria.garcia@sanignacio.edu',
      role: 'teacher',
      school_id: 'colegio-san-ignacio-123',
      school_name: 'Colegio San Ignacio'
    };

    document.addEventListener("DOMContentLoaded", () => {
      const today = new Date().toISOString().split("T")[0];
      document.getElementById("attendance-date").value = today;

      document.querySelectorAll(".btn[data-status]").forEach(btn => {
        btn.addEventListener("click", () => {
          selectedStatus = btn.dataset.status;
          document.querySelectorAll(".btn[data-status]").forEach(b => b.style.opacity = "0.6");
          btn.style.opacity = "1";
        });
      });

      document.getElementById("attendance-form").addEventListener("submit", async e => {
        e.preventDefault();
        if (!selectedStatus) return showError("Por favor selecciona un estado");

        const studentName = document.getElementById("student-name").value;
        const studentId = document.getElementById("student-id").value;
        const date = document.getElementById("attendance-date").value;
        const notes = document.getElementById("notes").value || "";

        try {
          const { addDoc, collection, serverTimestamp } = window.firebaseModules;
          const db = window.firebaseDb;

          await addDoc(collection(db, "attendance_individual"), {
            student_name: studentName,
            student_id: studentId,
            date: date,
            status: selectedStatus,
            teacher_id: currentUser.uid,
            teacher_name: currentUser.name,
            school_id: currentUser.school_id,
            notes: notes,
            timestamp: serverTimestamp()
          });

          showSuccess(`‚úÖ Asistencia guardada correctamente para ${studentName}`);
          e.target.reset();
          selectedStatus = null;
        } catch (err) {
          console.error(err);
          showError(`‚ùå Error guardando en Firebase: ${err.message}`);
        }
      });
    });

    function showError(msg) {
      const el = document.getElementById("attendance-error");
      el.textContent = msg;
      el.style.display = "block";
      setTimeout(() => el.style.display = "none", 6000);
    }

    function showSuccess(msg) {
      const el = document.getElementById("attendance-success");
      el.textContent = msg;
      el.style.display = "block";
      setTimeout(() => el.style.display = "none", 6000);
    }
  </script>
</body>
</html>
