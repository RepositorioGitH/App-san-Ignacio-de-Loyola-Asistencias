<!doctype html>
<html lang="es">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistema de Asistencia Escolar - Firebase</title><!-- Firebase SDK -->
  <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, addDoc, query, where, orderBy, getDocs, doc, getDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        
        // Configuraci√≥n Firebase - San Ignacio
        const firebaseConfig = {
            apiKey: "AIzaSyDjkCjj1iLMi3Z22o6cj1Xa-yYDoqjBm04",
            authDomain: "base-de-datos-san-ignacio.firebaseapp.com",
            projectId: "base-de-datos-san-ignacio",
            storageBucket: "base-de-datos-san-ignacio.firebasestorage.app",
            messagingSenderId: "698408506523",
            appId: "1:698408506523:web:ede2c739a1920e8956a23e",
            measurementId: "G-Z16V5DDNB8"
        };

        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // Hacer disponibles globalmente
        window.firebaseAuth = auth;
        window.firebaseDb = db;
        window.firebaseModules = {
            signInWithEmailAndPassword,
            createUserWithEmailAndPassword,
            signOut,
            onAuthStateChanged,
            collection,
            addDoc,
            query,
            where,
            orderBy,
            getDocs,
            doc,
            getDoc,
            serverTimestamp
        };
    </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
        body {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100%;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
            padding: 10px;
            min-height: 100%;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            color: #2d3748;
            margin: 0 0 10px 0;
            font-size: 24px;
            font-weight: 700;
        }

        .header p {
            color: #4a5568;
            margin: 0;
            font-size: 14px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #2d3748;
            font-weight: 600;
            font-size: 14px;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
            box-sizing: border-box;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #4299e1;
        }

        .btn {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 10px;
        }

        .btn-primary {
            background: #4299e1;
            color: white;
        }

        .btn-primary:hover {
            background: #3182ce;
        }

        .btn-success {
            background: #48bb78;
            color: white;
        }

        .btn-success:hover {
            background: #38a169;
        }

        .btn-warning {
            background: #ed8936;
            color: white;
        }

        .btn-warning:hover {
            background: #dd6b20;
        }

        .btn-danger {
            background: #f56565;
            color: white;
        }

        .btn-danger:hover {
            background: #e53e3e;
        }

        .btn-secondary {
            background: #a0aec0;
            color: white;
        }

        .btn-secondary:hover {
            background: #718096;
        }



        .nav-tabs {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 5px;
            margin-bottom: 20px;
            background: rgba(255, 255, 255, 0.1);
            padding: 5px;
            border-radius: 12px;
        }

        .nav-tab {
            padding: 10px;
            text-align: center;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: white;
            font-weight: 600;
            font-size: 14px;
        }

        .nav-tab.active {
            background: rgba(255, 255, 255, 0.9);
            color: #2d3748;
        }

        .tab-content {
            display: none;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .tab-content.active {
            display: block;
        }

        .student-form {
            display: grid;
            gap: 15px;
            margin-bottom: 20px;
        }

        .attendance-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            gap: 8px;
            margin-top: 10px;
        }

        .attendance-btn {
            padding: 8px;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .attendance-list {
            max-height: 400px;
            overflow-y: auto;
            margin-top: 20px;
        }

        .attendance-item {
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 10px;
            align-items: center;
        }

        .attendance-info h4 {
            margin: 0 0 5px 0;
            color: #2d3748;
            font-size: 14px;
        }

        .attendance-info p {
            margin: 0;
            color: #4a5568;
            font-size: 12px;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-align: center;
        }

        .status-presente {
            background: #c6f6d5;
            color: #22543d;
        }

        .status-ausente {
            background: #fed7d7;
            color: #742a2a;
        }

        .status-tardanza {
            background: #feebc8;
            color: #7b341e;
        }

        .status-justificado {
            background: #bee3f8;
            color: #2a4365;
        }

        .user-info {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            color: white;
            text-align: center;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #4a5568;
        }

        .spinner {
            border: 3px solid #e2e8f0;
            border-top: 3px solid #4299e1;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            background: #fed7d7;
            color: #742a2a;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: none;
        }

        .success-message {
            background: #c6f6d5;
            color: #22543d;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: none;
        }

        .firebase-status {
            background: rgba(255, 255, 255, 0.1);
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            color: white;
            text-align: center;
            font-size: 12px;
        }

        .firebase-status.connected {
            background: rgba(72, 187, 120, 0.2);
        }

        .firebase-status.error {
            background: rgba(245, 101, 101, 0.2);
        }

        /* Estilos de Autenticaci√≥n */
        .auth-screen {
            max-width: 500px;
            margin: 0 auto;
        }

        .auth-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .auth-tabs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 5px;
            margin-bottom: 25px;
            background: rgba(102, 126, 234, 0.1);
            padding: 5px;
            border-radius: 12px;
        }

        .auth-tab {
            padding: 12px;
            text-align: center;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #4a5568;
            font-weight: 600;
            font-size: 14px;
        }

        .auth-tab.active {
            background: #667eea;
            color: white;
        }

        .auth-form-container {
            display: none;
        }

        .auth-form-container.active {
            display: block;
        }

        .auth-form {
            display: grid;
            gap: 20px;
        }

        .auth-form h3 {
            text-align: center;
            color: #2d3748;
            margin: 0 0 20px 0;
            font-size: 24px;
        }

        .demo-accounts {
            margin-top: 25px;
            padding: 20px;
            background: rgba(102, 126, 234, 0.05);
            border-radius: 10px;
            border: 2px dashed rgba(102, 126, 234, 0.2);
        }

        .demo-accounts h4 {
            margin: 0 0 15px 0;
            color: #4a5568;
            font-size: 16px;
            text-align: center;
        }

        .demo-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .logout-section {
            background: rgba(255, 255, 255, 0.1);
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logout-btn {
            padding: 8px 15px;
            background: rgba(245, 101, 101, 0.8);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: rgba(245, 101, 101, 1);
        }

        .role-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-align: center;
        }

        .role-admin {
            background: #ffd700;
            color: #744210;
        }

        .role-user {
            background: #bee3f8;
            color: #2a4365;
        }

        @media (max-width: 480px) {
            .container {
                padding: 5px;
            }
            
            .header h1 {
                font-size: 20px;
            }
            
            .attendance-grid {
                grid-template-columns: 1fr 1fr;
                gap: 5px;
            }
            
            .attendance-btn {
                padding: 6px;
                font-size: 11px;
            }
            
            .nav-tabs {
                grid-template-columns: 1fr;
                gap: 2px;
            }
            
            .nav-tab {
                font-size: 12px;
                padding: 8px;
            }
        }
    </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="/_sdk/element_sdk.js" type="text/javascript"></script>
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
 </head>
 <body>
  <main class="container">
   <header class="header">
    <h1>Sistema de Asistencia Escolar - Firebase</h1>
    <p>A√±o Acad√©mico 2024-2025</p>
   </header><!-- Estado de Firebase -->
   <div id="firebase-status" class="firebase-status">
    üîÑ Inicializando Firebase...
   </div><!-- Panel de Diagn√≥stico Firebase (solo para desarrollo) -->
   <div id="firebase-debug" style="background: rgba(0,0,0,0.1); padding: 10px; border-radius: 8px; margin-bottom: 15px; font-size: 12px; color: white;">
    <div>
     <strong>üîß Diagn√≥stico Firebase:</strong>
    </div>
    <div id="debug-info">
     Cargando...
    </div><button onclick="testFirebaseManually()" style="margin-top: 5px; padding: 5px 10px; background: #4299e1; color: white; border: none; border-radius: 4px; cursor: pointer;"> üß™ Probar Conexi√≥n Manual </button>
   </div><!-- Pantalla de Autenticaci√≥n -->
   <section id="auth-screen" class="auth-screen" style="display: none;">
    <div class="auth-container">
     <div class="auth-tabs">
      <div class="auth-tab active" data-auth-tab="login">
       üîê Iniciar Sesi√≥n
      </div>
      <div class="auth-tab" data-auth-tab="register">
       üìù Registrarse
      </div>
     </div><!-- Login Form -->
     <div id="login-form-container" class="auth-form-container active">
      <h3>Iniciar Sesi√≥n</h3>
      <div class="error-message" id="login-error"></div>
      <div class="success-message" id="login-success"></div>
      <div class="loading" id="login-loading">
       <div class="spinner"></div> Iniciando sesi√≥n...
      </div>
      <form id="login-form" class="auth-form">
       <div class="form-group"><label for="login-email">üìß Correo Electr√≥nico:</label> <input type="email" id="login-email" name="email" required placeholder="usuario@sanignacio.edu">
       </div>
       <div class="form-group"><label for="login-password">üîí Contrase√±a:</label> <input type="password" id="login-password" name="password" required placeholder="Tu contrase√±a">
       </div><button type="submit" class="btn btn-primary">üöÄ Iniciar Sesi√≥n</button>
      </form>
      <div class="demo-accounts">
       <h4>üë• Cuentas de Demostraci√≥n:</h4>
       <div class="demo-buttons"><button class="btn btn-secondary" onclick="loginDemo('admin')"> üëë Admin Demo </button> <button class="btn btn-secondary" onclick="loginDemo('user')"> üë§ Usuario Demo </button>
       </div>
      </div>
     </div><!-- Register Form -->
     <div id="register-form-container" class="auth-form-container">
      <h3>Crear Cuenta Nueva</h3>
      <div class="error-message" id="register-error"></div>
      <div class="success-message" id="register-success"></div>
      <div class="loading" id="register-loading">
       <div class="spinner"></div> Creando cuenta...
      </div>
      <form id="register-form" class="auth-form">
       <div class="form-group"><label for="register-name">üë§ Nombre Completo:</label> <input type="text" id="register-name" name="name" required placeholder="Ej: Mar√≠a Garc√≠a L√≥pez">
       </div>
       <div class="form-group"><label for="register-email">üìß Correo Electr√≥nico:</label> <input type="email" id="register-email" name="email" required placeholder="usuario@sanignacio.edu">
       </div>
       <div class="form-group"><label for="register-password">üîí Contrase√±a:</label> <input type="password" id="register-password" name="password" required placeholder="M√≠nimo 6 caracteres">
       </div>
       <div class="form-group"><label for="register-role">üé≠ Rol de Usuario:</label> <select id="register-role" name="role" required> <option value="">Seleccionar rol</option> <option value="user">üë§ Usuario (Docente)</option> <option value="admin">üëë Administrador (Director)</option> </select>
       </div>
       <div class="form-group"><label for="register-department">üè´ Departamento/√Årea:</label> <select id="register-department" name="department" required> <option value="">Seleccionar departamento</option> <option value="primaria">üìö Educaci√≥n Primaria</option> <option value="secundaria">üéì Educaci√≥n Secundaria</option> <option value="matematicas">üî¢ Matem√°ticas</option> <option value="ciencias">üî¨ Ciencias Naturales</option> <option value="lenguaje">üìñ Lenguaje y Literatura</option> <option value="sociales">üåç Ciencias Sociales</option> <option value="educacion_fisica">‚öΩ Educaci√≥n F√≠sica</option> <option value="artes">üé® Artes</option> <option value="administracion">üè¢ Administraci√≥n</option> <option value="direccion">üëë Direcci√≥n</option> </select>
       </div><button type="submit" class="btn btn-success">‚ú® Crear Cuenta</button>
      </form>
     </div>
    </div>
   </section><!-- Aplicaci√≥n Principal -->
   <section id="main-app" class="main-app" style="display: none;">
    <div class="logout-section">
     <div style="color: white;">
      <div id="user-welcome" style="font-weight: 600; margin-bottom: 2px;">
       Bienvenido, Usuario
      </div>
      <div style="font-size: 12px; opacity: 0.8;"><span id="user-email">email@sanignacio.edu</span> ‚Ä¢ <span class="role-badge" id="user-role-badge">Usuario</span>
      </div>
     </div><button class="logout-btn" onclick="handleLogout()">üö™ Cerrar Sesi√≥n</button>
    </div>
    <div class="user-info">
     <h3 id="user-department">Departamento: No asignado</h3>
     <p id="user-school">Instituci√≥n: Colegio San Ignacio</p>
    </div>
    <nav class="nav-tabs">
     <div class="nav-tab active" data-tab="attendance">
      üìù Individual
     </div>
     <div class="nav-tab" data-tab="classroom">
      üè´ Por Aula
     </div>
     <div class="nav-tab" data-tab="reports">
      üìä Reportes
     </div>
     <div class="nav-tab" data-tab="students" id="students-tab" style="display: none;">
      üë• Estudiantes
     </div>
    </nav><!-- Tab de Asistencia Individual -->
    <div id="attendance-tab" class="tab-content active">
     <h3>Registro de Asistencia Individual</h3>
     <div class="success-message" id="attendance-success"></div>
     <div class="error-message" id="attendance-error"></div>
     <div class="loading" id="attendance-loading">
      <div class="spinner"></div> Guardando en Firebase...
     </div>
     <form id="attendance-form" class="student-form">
      <div class="form-group"><label for="student-name">Nombre del Estudiante:</label> <input type="text" id="student-name" name="student-name" required>
      </div>
      <div class="form-group"><label for="student-id">ID del Estudiante:</label> <input type="text" id="student-id" name="student-id" required>
      </div>
      <div class="form-group"><label for="attendance-date">Fecha:</label> <input type="date" id="attendance-date" name="attendance-date" required>
      </div>
      <div class="form-group"><label for="notes">Notas (opcional):</label> <input type="text" id="notes" name="notes" placeholder="Observaciones adicionales...">
      </div>
      <div class="attendance-grid"><button type="button" class="attendance-btn btn-success" data-status="presente"> ‚úÖ Presente </button> <button type="button" class="attendance-btn btn-danger" data-status="ausente"> ‚ùå Ausente </button> <button type="button" class="attendance-btn btn-warning" data-status="tardanza"> ‚è∞ Tardanza </button> <button type="button" class="attendance-btn btn-secondary" data-status="justificado"> üìã Justificado </button>
      </div>
     </form>
     <div class="attendance-list" id="attendance-list">
      <h4>Registros de Hoy (Firebase)</h4>
      <div id="today-records"></div>
     </div>
    </div><!-- Tab de Asistencia por Aula -->
    <div id="classroom-tab" class="tab-content">
     <h3>Asistencia por Aula</h3>
     <div class="success-message" id="classroom-success"></div>
     <div class="error-message" id="classroom-error"></div>
     <div class="loading" id="classroom-loading">
      <div class="spinner"></div> Guardando aula en Firebase...
     </div>
     <form id="classroom-form" class="student-form">
      <div class="form-group"><label for="classroom-grade">Grado:</label> <select id="classroom-grade" name="classroom-grade" required> <option value="">Seleccionar grado</option> <option value="7mo">7mo Grado</option> <option value="8vo">8vo Grado</option> <option value="9no">9no Grado</option> <option value="10mo">10mo Grado</option> <option value="11vo">11vo Grado</option> </select>
      </div>
      <div class="form-group"><label for="classroom-section">Secci√≥n:</label> <select id="classroom-section" name="classroom-section" required> <option value="">Seleccionar secci√≥n</option> <option value="A">Secci√≥n A</option> <option value="B">Secci√≥n B</option> <option value="C">Secci√≥n C</option> <option value="D">Secci√≥n D</option> </select>
      </div>
      <div class="form-group"><label for="classroom-date">Fecha:</label> <input type="date" id="classroom-date" name="classroom-date" required>
      </div>
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 20px 0;">
       <div class="form-group"><label for="male-present">üë¶ Varones Presentes:</label> <input type="number" id="male-present" name="male-present" min="0" value="0" required>
       </div>
       <div class="form-group"><label for="female-present">üëß Mujeres Presentes:</label> <input type="number" id="female-present" name="female-present" min="0" value="0" required>
       </div>
      </div>
      <div class="form-group"><label for="total-absent">‚ùå Total de Ausentes:</label> <input type="number" id="total-absent" name="total-absent" min="0" value="0" required>
      </div>
      <div class="form-group"><label for="total-enrolled">üë• Total Matriculados en el Aula:</label> <input type="number" id="total-enrolled" name="total-enrolled" min="1" required>
      </div>
      <div class="form-group"><label for="classroom-notes">Observaciones (opcional):</label> <input type="text" id="classroom-notes" name="classroom-notes" placeholder="Notas adicionales sobre el aula...">
      </div><button type="submit" class="btn btn-primary">üíæ Guardar en Firebase</button>
     </form>
     <div class="attendance-list" id="classroom-list">
      <h4>Registros de Aulas de Hoy (Firebase)</h4>
      <div id="today-classroom-records"></div>
     </div>
    </div><!-- Tab de Reportes -->
    <div id="reports-tab" class="tab-content">
     <h3>Generar Reportes desde Firebase</h3>
     <div class="success-message" id="report-success"></div>
     <div class="error-message" id="report-error"></div>
     <div class="loading" id="report-loading">
      <div class="spinner"></div> Consultando Firebase...
     </div>
     <div class="form-group"><label for="report-start-date">Fecha de Inicio:</label> <input type="date" id="report-start-date">
     </div>
     <div class="form-group"><label for="report-end-date">Fecha de Fin:</label> <input type="date" id="report-end-date">
     </div><button class="btn btn-success" onclick="generateFirebaseReport()"> üìä Generar Reporte desde Firebase </button>
     <div id="report-summary" style="margin-top: 20px;"></div>
    </div><!-- Tab de Estudiantes (Solo Director) -->
    <div id="students-tab-content" class="tab-content">
     <h3>Gesti√≥n de Estudiantes (Firebase)</h3>
     <p>Funcionalidad disponible solo para directores</p>
     <div id="all-records"></div>
    </div>
   </section>
  </main>
  <script>
        // Variables globales
        let currentUser = null;
        let selectedStatus = null;
        let attendanceRecords = [];
        let classroomRecords = [];

        // Servicios Firebase
        class FirebaseUserService {
            constructor() {
                this.db = window.firebaseDb;
                this.modules = window.firebaseModules;
            }

            async createUserProfile(uid, userData) {
                try {
                    console.log('üîÑ Creando perfil de usuario:', userData);
                    
                    const userProfile = {
                        uid: uid,
                        name: userData.name,
                        email: userData.email,
                        role: userData.role,
                        department: userData.department,
                        school_id: 'colegio-san-ignacio-123',
                        school_name: 'Colegio San Ignacio',
                        created_at: new Date().toISOString(),
                        timestamp: this.modules.serverTimestamp()
                    };

                    await this.modules.addDoc(
                        this.modules.collection(this.db, 'users'), 
                        userProfile
                    );
                    
                    console.log('‚úÖ Perfil de usuario creado exitosamente');
                    return { success: true, profile: userProfile };
                } catch (error) {
                    console.error('‚ùå Error creating user profile:', error);
                    return { success: false, error: error.message };
                }
            }

            async getUserProfile(uid) {
                try {
                    const q = this.modules.query(
                        this.modules.collection(this.db, 'users'),
                        this.modules.where('uid', '==', uid)
                    );
                    
                    const querySnapshot = await this.modules.getDocs(q);
                    
                    if (!querySnapshot.empty) {
                        const userDoc = querySnapshot.docs[0];
                        return { success: true, profile: { id: userDoc.id, ...userDoc.data() } };
                    } else {
                        return { success: false, error: 'Perfil de usuario no encontrado' };
                    }
                } catch (error) {
                    console.error('‚ùå Error getting user profile:', error);
                    return { success: false, error: error.message };
                }
            }
        }

        class FirebaseAttendanceService {
            constructor() {
                this.db = window.firebaseDb;
                this.modules = window.firebaseModules;
            }

            async createIndividualAttendance(attendanceData) {
                try {
                    console.log('üîÑ Intentando guardar en Firebase:', attendanceData);
                    
                    if (!this.db || !this.modules) {
                        throw new Error('Firebase no est√° inicializado correctamente');
                    }

                    const docData = {
                        ...attendanceData,
                        timestamp: this.modules.serverTimestamp(),
                        created_at: new Date().toISOString()
                    };

                    console.log('üìù Datos a guardar:', docData);

                    const docRef = await this.modules.addDoc(
                        this.modules.collection(this.db, 'attendance_individual'), 
                        docData
                    );
                    
                    console.log('‚úÖ Documento guardado con ID:', docRef.id);
                    return { success: true, id: docRef.id };
                } catch (error) {
                    console.error('‚ùå Error creating individual attendance:', error);
                    console.error('Error details:', error.code, error.message);
                    return { success: false, error: `${error.code || 'UNKNOWN'}: ${error.message}` };
                }
            }

            async createClassroomAttendance(classroomData) {
                try {
                    console.log('üîÑ Intentando guardar aula en Firebase:', classroomData);
                    
                    if (!this.db || !this.modules) {
                        throw new Error('Firebase no est√° inicializado correctamente');
                    }

                    const docData = {
                        ...classroomData,
                        timestamp: this.modules.serverTimestamp(),
                        created_at: new Date().toISOString()
                    };

                    console.log('üìù Datos de aula a guardar:', docData);

                    const docRef = await this.modules.addDoc(
                        this.modules.collection(this.db, 'attendance_classroom'), 
                        docData
                    );
                    
                    console.log('‚úÖ Aula guardada con ID:', docRef.id);
                    return { success: true, id: docRef.id };
                } catch (error) {
                    console.error('‚ùå Error creating classroom attendance:', error);
                    console.error('Error details:', error.code, error.message);
                    return { success: false, error: `${error.code || 'UNKNOWN'}: ${error.message}` };
                }
            }

            async getAttendanceByDate(schoolId, startDate, endDate, type = 'individual') {
                try {
                    const collectionName = type === 'individual' ? 'attendance_individual' : 'attendance_classroom';
                    const q = this.modules.query(
                        this.modules.collection(this.db, collectionName),
                        this.modules.where('school_id', '==', schoolId),
                        this.modules.where('date', '>=', startDate),
                        this.modules.where('date', '<=', endDate),
                        this.modules.orderBy('date', 'desc')
                    );
                    
                    const querySnapshot = await this.modules.getDocs(q);
                    const records = [];
                    querySnapshot.forEach((doc) => {
                        records.push({ id: doc.id, ...doc.data() });
                    });
                    
                    return { success: true, data: records };
                } catch (error) {
                    console.error('Error getting attendance:', error);
                    return { success: false, error: error.message };
                }
            }

            async getTodayAttendance(schoolId, type = 'individual') {
                const today = new Date().toISOString().split('T')[0];
                return this.getAttendanceByDate(schoolId, today, today, type);
            }
        }

        class FirebaseAuthService {
            constructor() {
                this.auth = window.firebaseAuth;
                this.db = window.firebaseDb;
                this.modules = window.firebaseModules;
            }

            async register(email, password, userData) {
                try {
                    console.log('üîÑ Registrando usuario:', email);
                    
                    // Crear usuario en Firebase Auth
                    const userCredential = await this.modules.createUserWithEmailAndPassword(this.auth, email, password);
                    const user = userCredential.user;
                    
                    console.log('‚úÖ Usuario creado en Auth:', user.uid);
                    
                    // Crear perfil en Firestore
                    const userService = new FirebaseUserService();
                    const profileResult = await userService.createUserProfile(user.uid, {
                        ...userData,
                        email: user.email
                    });
                    
                    if (!profileResult.success) {
                        throw new Error('Error creando perfil: ' + profileResult.error);
                    }
                    
                    return { 
                        success: true, 
                        user: { 
                            uid: user.uid, 
                            email: user.email, 
                            ...profileResult.profile 
                        } 
                    };
                } catch (error) {
                    console.error('‚ùå Register error:', error);
                    return { success: false, error: this.getErrorMessage(error.code) || error.message };
                }
            }

            async login(email, password) {
                try {
                    console.log('üîÑ Iniciando sesi√≥n:', email);
                    
                    const userCredential = await this.modules.signInWithEmailAndPassword(this.auth, email, password);
                    const user = userCredential.user;
                    
                    console.log('‚úÖ Usuario autenticado:', user.uid);
                    
                    // Obtener perfil del usuario
                    const userService = new FirebaseUserService();
                    const profileResult = await userService.getUserProfile(user.uid);
                    
                    if (!profileResult.success) {
                        throw new Error('Perfil de usuario no encontrado');
                    }
                    
                    return { 
                        success: true, 
                        user: { 
                            uid: user.uid, 
                            email: user.email, 
                            ...profileResult.profile 
                        } 
                    };
                } catch (error) {
                    console.error('‚ùå Login error:', error);
                    return { success: false, error: this.getErrorMessage(error.code) || error.message };
                }
            }

            async logout() {
                try {
                    await this.modules.signOut(this.auth);
                    return { success: true };
                } catch (error) {
                    return { success: false, error: error.message };
                }
            }

            onAuthChange(callback) {
                return this.modules.onAuthStateChanged(this.auth, async (user) => {
                    if (user) {
                        try {
                            const userService = new FirebaseUserService();
                            const profileResult = await userService.getUserProfile(user.uid);
                            
                            if (profileResult.success) {
                                callback({ 
                                    uid: user.uid, 
                                    email: user.email, 
                                    ...profileResult.profile 
                                });
                            } else {
                                callback(null);
                            }
                        } catch (error) {
                            console.error('Error getting user data:', error);
                            callback(null);
                        }
                    } else {
                        callback(null);
                    }
                });
            }

            getErrorMessage(errorCode) {
                const errorMessages = {
                    'auth/email-already-in-use': 'Este correo electr√≥nico ya est√° registrado',
                    'auth/weak-password': 'La contrase√±a debe tener al menos 6 caracteres',
                    'auth/invalid-email': 'Correo electr√≥nico inv√°lido',
                    'auth/user-not-found': 'Usuario no encontrado',
                    'auth/wrong-password': 'Contrase√±a incorrecta',
                    'auth/too-many-requests': 'Demasiados intentos fallidos. Intenta m√°s tarde',
                    'auth/network-request-failed': 'Error de conexi√≥n. Verifica tu internet'
                };
                return errorMessages[errorCode] || 'Error de autenticaci√≥n';
            }
        }

        // Instancias de servicios
        let attendanceService;
        let authService;
        let userService;

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ DOM cargado, inicializando aplicaci√≥n...');
            
            // Mostrar pantalla de auth por defecto
            showAuthScreen();
            
            // Inicializar app
            initializeApp().catch(error => {
                console.error('‚ùå Error fatal en inicializaci√≥n:', error);
                updateFirebaseStatus('error', '‚ùå Error fatal: ' + error.message);
                // Asegurar que se muestre la pantalla de auth
                showAuthScreen();
            });
        });

        async function initializeApp() {
            try {
                console.log('üöÄ Iniciando aplicaci√≥n...');
                
                // Esperar a que Firebase est√© disponible
                await waitForFirebase();
                console.log('‚úÖ Firebase disponible');

                // Inicializar servicios
                attendanceService = new FirebaseAttendanceService();
                authService = new FirebaseAuthService();
                userService = new FirebaseUserService();
                console.log('‚úÖ Servicios inicializados');

                setupEventListeners();
                setTodayDate();

                // Configurar listener de autenticaci√≥n ANTES de cualquier otra cosa
                console.log('üîÑ Configurando listener de autenticaci√≥n...');
                authService.onAuthChange((user) => {
                    console.log('üîÑ Estado de autenticaci√≥n cambi√≥:', user ? 'Usuario logueado' : 'Usuario no logueado');
                    
                    if (user) {
                        console.log('‚úÖ Usuario autenticado:', user);
                        currentUser = user;
                        showMainApp();
                        updateUserInterface();
                        loadTodayData();
                        updateFirebaseStatus('connected', `‚úÖ Conectado como ${user.name || user.email}`);
                    } else {
                        console.log('‚ùå Usuario no autenticado');
                        currentUser = null;
                        showAuthScreen();
                        updateFirebaseStatus('connected', '‚ö†Ô∏è Firebase listo - Esperando login');
                    }
                });

                // Probar conexi√≥n b√°sica a Firebase
                try {
                    await testFirebaseConnection();
                    console.log('‚úÖ Conexi√≥n a Firebase exitosa');
                    updateFirebaseStatus('connected', '‚úÖ Firebase conectado - Listo para usar');
                } catch (error) {
                    console.warn('‚ö†Ô∏è Conexi√≥n inicial fall√≥, pero continuando:', error);
                    updateFirebaseStatus('connected', '‚ö†Ô∏è Firebase inicializado - Puede haber problemas de red');
                }

                console.log('üéâ Aplicaci√≥n inicializada correctamente');

            } catch (error) {
                console.error('‚ùå Error cr√≠tico inicializando aplicaci√≥n:', error);
                updateFirebaseStatus('error', '‚ùå Error cr√≠tico: ' + error.message);
                // Asegurar que se muestre la pantalla de auth
                showAuthScreen();
            }
        }

        function waitForFirebase() {
            return new Promise((resolve, reject) => {
                let attempts = 0;
                const maxAttempts = 50;
                
                const checkFirebase = () => {
                    attempts++;
                    if (window.firebaseDb && window.firebaseModules) {
                        resolve();
                    } else if (attempts >= maxAttempts) {
                        reject(new Error('Firebase no se carg√≥ correctamente'));
                    } else {
                        setTimeout(checkFirebase, 100);
                    }
                };
                
                checkFirebase();
            });
        }

        async function testFirebaseConnection() {
            try {
                // Intentar crear una colecci√≥n de prueba (sin depender de currentUser)
                const testDoc = {
                    test: true,
                    timestamp: new Date().toISOString(),
                    school_id: 'test-connection'
                };
                
                const docRef = await window.firebaseModules.addDoc(
                    window.firebaseModules.collection(window.firebaseDb, 'connection_test'), 
                    testDoc
                );
                
                console.log('‚úÖ Conexi√≥n a Firebase exitosa. Test doc ID:', docRef.id);
                return true;
            } catch (error) {
                console.error('‚ùå Error de conexi√≥n a Firebase:', error);
                throw error;
            }
        }

        function updateFirebaseStatus(status, message) {
            const statusElement = document.getElementById('firebase-status');
            statusElement.className = `firebase-status ${status}`;
            statusElement.textContent = message;
        }

        function setupEventListeners() {
            // Tabs de autenticaci√≥n
            document.querySelectorAll('.auth-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabName = this.dataset.authTab;
                    switchAuthTab(tabName);
                });
            });

            // Forms de autenticaci√≥n
            document.getElementById('login-form').addEventListener('submit', handleLogin);
            document.getElementById('register-form').addEventListener('submit', handleRegister);

            // Tabs de navegaci√≥n
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabName = this.dataset.tab;
                    switchTab(tabName);
                });
            });

            // Botones de asistencia
            document.querySelectorAll('.attendance-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    selectAttendanceStatus(this.dataset.status);
                });
            });

            // Forms
            document.getElementById('attendance-form').addEventListener('submit', handleFirebaseAttendanceSubmit);
            document.getElementById('classroom-form').addEventListener('submit', handleFirebaseClassroomSubmit);

            // Reportes
            document.getElementById('report-start-date').addEventListener('change', updateFirebaseReportSummary);
            document.getElementById('report-end-date').addEventListener('change', updateFirebaseReportSummary);
        }

        function showAuthScreen() {
            document.getElementById('auth-screen').style.display = 'block';
            document.getElementById('main-app').style.display = 'none';
        }

        function showMainApp() {
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('main-app').style.display = 'block';
        }

        function switchAuthTab(tabName) {
            // Actualizar tabs activos
            document.querySelectorAll('.auth-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[data-auth-tab="${tabName}"]`).classList.add('active');

            // Mostrar contenido correspondiente
            document.querySelectorAll('.auth-form-container').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`${tabName}-form-container`).classList.add('active');
        }

        function updateUserInterface() {
            if (!currentUser) return;

            // Actualizar informaci√≥n del usuario
            document.getElementById('user-welcome').textContent = `Bienvenido, ${currentUser.name}`;
            document.getElementById('user-email').textContent = currentUser.email;
            document.getElementById('user-department').textContent = `Departamento: ${getDepartmentName(currentUser.department)}`;
            
            // Actualizar badge de rol
            const roleBadge = document.getElementById('user-role-badge');
            roleBadge.textContent = currentUser.role === 'admin' ? 'üëë Administrador' : 'üë§ Usuario';
            roleBadge.className = `role-badge ${currentUser.role === 'admin' ? 'role-admin' : 'role-user'}`;

            // Mostrar/ocultar tabs seg√∫n el rol
            const studentsTab = document.getElementById('students-tab');
            if (currentUser.role === 'admin') {
                studentsTab.style.display = 'block';
            } else {
                studentsTab.style.display = 'none';
            }
        }

        function getDepartmentName(department) {
            const departments = {
                'primaria': 'üìö Educaci√≥n Primaria',
                'secundaria': 'üéì Educaci√≥n Secundaria',
                'matematicas': 'üî¢ Matem√°ticas',
                'ciencias': 'üî¨ Ciencias Naturales',
                'lenguaje': 'üìñ Lenguaje y Literatura',
                'sociales': 'üåç Ciencias Sociales',
                'educacion_fisica': '‚öΩ Educaci√≥n F√≠sica',
                'artes': 'üé® Artes',
                'administracion': 'üè¢ Administraci√≥n',
                'direccion': 'üëë Direcci√≥n'
            };
            return departments[department] || department;
        }

        async function handleLogin(e) {
            e.preventDefault();

            const formData = new FormData(e.target);
            const email = formData.get('email');
            const password = formData.get('password');

            console.log('üîÑ Intentando login con:', email);

            if (!email || !password) {
                showError('login-error', 'Por favor completa todos los campos');
                return;
            }

            // Verificar que authService est√© disponible
            if (!authService) {
                showError('login-error', 'Sistema de autenticaci√≥n no est√° listo. Recarga la p√°gina.');
                return;
            }

            // Limpiar errores previos
            document.getElementById('login-error').style.display = 'none';
            showLoading('login-loading', true);

            try {
                console.log('üîÑ Llamando a authService.login...');
                const result = await authService.login(email, password);
                
                console.log('üìã Resultado del login:', result);
                showLoading('login-loading', false);

                if (result.success) {
                    console.log('‚úÖ Login exitoso:', result.user);
                    // El listener onAuthChange se encargar√° de mostrar la app principal
                    showSuccess('login-success', '‚úÖ Iniciando sesi√≥n...');
                } else {
                    console.error('‚ùå Login fall√≥:', result.error);
                    showError('login-error', `‚ùå ${result.error}`);
                }
            } catch (error) {
                showLoading('login-loading', false);
                console.error('‚ùå Error cr√≠tico en handleLogin:', error);
                showError('login-error', `‚ùå Error cr√≠tico: ${error.message}`);
            }
        }

        async function handleRegister(e) {
            e.preventDefault();

            const formData = new FormData(e.target);
            const name = formData.get('name');
            const email = formData.get('email');
            const password = formData.get('password');
            const role = formData.get('role');
            const department = formData.get('department');

            if (!name || !email || !password || !role || !department) {
                showError('register-error', 'Por favor completa todos los campos');
                return;
            }

            if (password.length < 6) {
                showError('register-error', 'La contrase√±a debe tener al menos 6 caracteres');
                return;
            }

            showLoading('register-loading', true);

            const result = await authService.register(email, password, {
                name: name,
                role: role,
                department: department
            });
            
            showLoading('register-loading', false);

            if (result.success) {
                showSuccess('register-success', `‚úÖ Cuenta creada exitosamente para ${name}. Iniciando sesi√≥n...`);
                e.target.reset();
                
                // Cambiar a tab de login despu√©s de un momento
                setTimeout(() => {
                    switchAuthTab('login');
                }, 2000);
            } else {
                showError('register-error', `‚ùå ${result.error}`);
            }
        }

        async function handleLogout() {
            const result = await authService.logout();
            if (result.success) {
                console.log('‚úÖ Logout exitoso');
                // El listener onAuthChange se encargar√° de mostrar la pantalla de login
            } else {
                console.error('‚ùå Error en logout:', result.error);
            }
        }

        async function loginDemo(role) {
            console.log(`üîÑ Iniciando login demo para rol: ${role}`);
            
            // Verificar que authService est√© disponible
            if (!authService) {
                showError('login-error', 'Sistema de autenticaci√≥n no est√° listo. Recarga la p√°gina.');
                return;
            }

            // Limpiar errores previos
            document.getElementById('login-error').style.display = 'none';
            document.getElementById('login-success').style.display = 'none';
            showLoading('login-loading', true);

            try {
                // Credenciales de demostraci√≥n
                const demoCredentials = {
                    admin: {
                        email: 'admin@sanignacio.edu',
                        password: 'admin123'
                    },
                    user: {
                        email: 'docente@sanignacio.edu',
                        password: 'docente123'
                    }
                };

                const credentials = demoCredentials[role];
                if (!credentials) {
                    showLoading('login-loading', false);
                    showError('login-error', 'Credenciales de demostraci√≥n no v√°lidas');
                    return;
                }

                console.log(`üîÑ Intentando login demo para ${role}:`, credentials.email);

                const result = await authService.login(credentials.email, credentials.password);
                
                if (result.success) {
                    showLoading('login-loading', false);
                    console.log('‚úÖ Login demo exitoso:', result.user);
                    showSuccess('login-success', `‚úÖ Acceso demo como ${role === 'admin' ? 'Administrador' : 'Docente'}`);
                } else {
                    console.log('‚ùå Login demo fall√≥, intentando crear usuario:', result.error);
                    
                    // Si el usuario demo no existe, intentar crearlo
                    if (result.error.includes('Usuario no encontrado') || 
                        result.error.includes('user-not-found') || 
                        result.error.includes('Perfil de usuario no encontrado')) {
                        
                        console.log('üîÑ Creando usuario demo...');
                        
                        const userData = {
                            name: role === 'admin' ? 'Administrador Demo' : 'Docente Demo',
                            role: role === 'admin' ? 'admin' : 'user',
                            department: role === 'admin' ? 'direccion' : 'primaria'
                        };

                        const registerResult = await authService.register(credentials.email, credentials.password, userData);
                        
                        showLoading('login-loading', false);

                        if (registerResult.success) {
                            console.log('‚úÖ Usuario demo creado y logueado:', registerResult.user);
                            showSuccess('login-success', `‚úÖ Usuario demo creado. Accediendo como ${role === 'admin' ? 'Administrador' : 'Docente'}...`);
                        } else {
                            console.error('‚ùå Error creando usuario demo:', registerResult.error);
                            showError('login-error', `‚ùå Error creando usuario demo: ${registerResult.error}`);
                        }
                    } else {
                        showLoading('login-loading', false);
                        showError('login-error', `‚ùå ${result.error}`);
                    }
                }
            } catch (error) {
                showLoading('login-loading', false);
                console.error('‚ùå Error cr√≠tico en loginDemo:', error);
                showError('login-error', `‚ùå Error cr√≠tico en demo: ${error.message}`);
            }
        }

        function setTodayDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('attendance-date').value = today;
            document.getElementById('classroom-date').value = today;
            document.getElementById('report-start-date').value = today;
            document.getElementById('report-end-date').value = today;
        }



        function switchTab(tabName) {
            // Actualizar tabs activos
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

            // Mostrar contenido correspondiente
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`${tabName}-tab`).classList.add('active');

            // Cargar datos espec√≠ficos del tab
            if (tabName === 'students' && currentUser.role === 'director') {
                loadAllFirebaseRecords();
            } else if (tabName === 'reports') {
                updateFirebaseReportSummary();
            }
        }

        function selectAttendanceStatus(status) {
            selectedStatus = status;
            
            // Actualizar botones
            document.querySelectorAll('.attendance-btn').forEach(btn => {
                btn.style.opacity = btn.dataset.status === status ? '1' : '0.5';
                btn.style.transform = btn.dataset.status === status ? 'scale(1.05)' : 'scale(1)';
            });
        }

        async function handleFirebaseAttendanceSubmit(e) {
            e.preventDefault();

            if (!selectedStatus) {
                showError('attendance-error', 'Por favor selecciona un estado de asistencia');
                return;
            }

            if (!currentUser || !currentUser.school_id) {
                showError('attendance-error', 'Error: Usuario no tiene escuela asignada');
                return;
            }

            const formData = new FormData(e.target);
            const studentName = formData.get('student-name');
            const studentId = formData.get('student-id');
            const date = formData.get('attendance-date');
            const notes = formData.get('notes') || '';

            showLoading('attendance-loading', true);

            const attendanceRecord = {
                student_name: studentName,
                student_id: studentId,
                date: date,
                status: selectedStatus,
                teacher_id: currentUser.uid,
                teacher_name: currentUser.name || currentUser.email,
                school_id: currentUser.school_id,
                notes: notes
            };

            const result = await attendanceService.createIndividualAttendance(attendanceRecord);
            
            showLoading('attendance-loading', false);

            if (result.success) {
                showSuccess('attendance-success', `‚úÖ Asistencia guardada en Firebase para ${studentName}`);
                e.target.reset();
                setTodayDate();
                selectedStatus = null;
                
                // Resetear botones
                document.querySelectorAll('.attendance-btn').forEach(btn => {
                    btn.style.opacity = '1';
                    btn.style.transform = 'scale(1)';
                });

                // Recargar datos
                loadTodayData();
            } else {
                showError('attendance-error', `‚ùå Error de Firebase: ${result.error}`);
            }
        }

        async function handleFirebaseClassroomSubmit(e) {
            e.preventDefault();

            if (!currentUser || !currentUser.school_id) {
                showError('classroom-error', 'Error: Usuario no tiene escuela asignada');
                return;
            }

            const formData = new FormData(e.target);
            const grade = formData.get('classroom-grade');
            const section = formData.get('classroom-section');
            const date = formData.get('classroom-date');
            const malePresent = parseInt(formData.get('male-present')) || 0;
            const femalePresent = parseInt(formData.get('female-present')) || 0;
            const totalAbsent = parseInt(formData.get('total-absent')) || 0;
            const totalEnrolled = parseInt(formData.get('total-enrolled')) || 0;
            const notes = formData.get('classroom-notes') || '';

            // Validaciones
            const totalPresent = malePresent + femalePresent;
            if (totalPresent + totalAbsent !== totalEnrolled) {
                showError('classroom-error', `‚ùå Error: Los presentes (${totalPresent}) + ausentes (${totalAbsent}) deben sumar el total matriculado (${totalEnrolled})`);
                return;
            }

            showLoading('classroom-loading', true);

            const classroomRecord = {
                grade: grade,
                section: section,
                date: date,
                male_present: malePresent,
                female_present: femalePresent,
                total_absent: totalAbsent,
                total_enrolled: totalEnrolled,
                teacher_id: currentUser.uid,
                teacher_name: currentUser.name || currentUser.email,
                school_id: currentUser.school_id,
                notes: notes
            };

            const result = await attendanceService.createClassroomAttendance(classroomRecord);
            
            showLoading('classroom-loading', false);

            if (result.success) {
                showSuccess('classroom-success', `‚úÖ Aula guardada en Firebase: ${grade} ${section} - ${totalPresent} presentes, ${totalAbsent} ausentes`);
                e.target.reset();
                setTodayDate();
                loadTodayData();
            } else {
                showError('classroom-error', `‚ùå Error de Firebase: ${result.error}`);
            }
        }

        async function loadTodayData() {
            if (!currentUser || !currentUser.school_id) return;

            try {
                // Cargar asistencia individual
                const individualResult = await attendanceService.getTodayAttendance(currentUser.school_id, 'individual');
                if (individualResult.success) {
                    attendanceRecords = individualResult.data;
                    updateAttendanceDisplay();
                }

                // Cargar asistencia por aula
                const classroomResult = await attendanceService.getTodayAttendance(currentUser.school_id, 'classroom');
                if (classroomResult.success) {
                    classroomRecords = classroomResult.data;
                    updateClassroomDisplay();
                }
            } catch (error) {
                console.error('Error loading today data:', error);
            }
        }

        function updateAttendanceDisplay() {
            const container = document.getElementById('today-records');
            
            if (attendanceRecords.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #4a5568; padding: 20px;">üì≠ No hay registros individuales para hoy en Firebase</p>';
                return;
            }

            container.innerHTML = attendanceRecords.map(record => `
                <div class="attendance-item">
                    <div class="attendance-info">
                        <h4>${record.student_name} (ID: ${record.student_id})</h4>
                        <p>üë®‚Äçüè´ Docente: ${record.teacher_name}</p>
                        ${record.notes ? `<p>üìù Notas: ${record.notes}</p>` : ''}
                        <p style="font-size: 10px; color: #718096;">üî• Firebase ID: ${record.id}</p>
                    </div>
                    <div class="status-badge status-${record.status}">
                        ${getStatusText(record.status)}
                    </div>
                </div>
            `).join('');
        }

        function updateClassroomDisplay() {
            const container = document.getElementById('today-classroom-records');
            
            if (classroomRecords.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #4a5568; padding: 20px;">üì≠ No hay registros de aulas para hoy en Firebase</p>';
                return;
            }

            container.innerHTML = classroomRecords.map(record => `
                <div class="attendance-item">
                    <div class="attendance-info">
                        <h4>üè´ ${record.grade} - Secci√≥n ${record.section}</h4>
                        <p>üë¶ Varones: ${record.male_present} | üëß Mujeres: ${record.female_present}</p>
                        <p>‚ùå Ausentes: ${record.total_absent} | üë• Total: ${record.total_enrolled}</p>
                        <p>üë®‚Äçüè´ Docente: ${record.teacher_name}</p>
                        ${record.notes ? `<p>üìù Notas: ${record.notes}</p>` : ''}
                        <p style="font-size: 10px; color: #718096;">üî• Firebase ID: ${record.id}</p>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 24px; font-weight: bold; color: #48bb78;">
                            ${record.male_present + record.female_present}
                        </div>
                        <div style="font-size: 12px; color: #4a5568;">Presentes</div>
                    </div>
                </div>
            `).join('');
        }

        async function generateFirebaseReport() {
            const startDate = document.getElementById('report-start-date').value;
            const endDate = document.getElementById('report-end-date').value;

            if (!startDate || !endDate) {
                showError('report-error', 'Por favor selecciona las fechas de inicio y fin');
                return;
            }

            if (!currentUser || !currentUser.school_id) {
                showError('report-error', 'Error: Usuario no tiene escuela asignada');
                return;
            }

            showLoading('report-loading', true);

            try {
                // Obtener datos de Firebase
                const [individualResult, classroomResult] = await Promise.all([
                    attendanceService.getAttendanceByDate(currentUser.school_id, startDate, endDate, 'individual'),
                    attendanceService.getAttendanceByDate(currentUser.school_id, startDate, endDate, 'classroom')
                ]);

                if (!individualResult.success || !classroomResult.success) {
                    throw new Error('Error al obtener datos de Firebase');
                }

                const individualData = individualResult.data;
                const classroomData = classroomResult.data;

                if (individualData.length === 0 && classroomData.length === 0) {
                    showLoading('report-loading', false);
                    showError('report-error', 'No hay registros en Firebase para el rango de fechas seleccionado');
                    return;
                }

                // Preparar datos para Excel - Registros Individuales
                const individualExcelData = individualData.map(record => ({
                    'Fecha': record.date,
                    'Nombre del Estudiante': record.student_name,
                    'ID Estudiante': record.student_id,
                    'Estado': getStatusText(record.status),
                    'Docente': record.teacher_name,
                    'Notas': record.notes || '',
                    'Firebase ID': record.id,
                    'Hora de Registro': record.timestamp ? new Date(record.timestamp.seconds * 1000).toLocaleString('es-ES') : 'N/A'
                }));

                // Preparar datos para Excel - Registros por Aula
                const classroomExcelData = classroomData.map(record => ({
                    'Fecha': record.date,
                    'Grado': record.grade,
                    'Secci√≥n': record.section,
                    'Varones Presentes': record.male_present,
                    'Mujeres Presentes': record.female_present,
                    'Total Presentes': record.male_present + record.female_present,
                    'Total Ausentes': record.total_absent,
                    'Total Matriculados': record.total_enrolled,
                    'Docente': record.teacher_name,
                    'Notas': record.notes || '',
                    'Firebase ID': record.id,
                    'Hora de Registro': record.timestamp ? new Date(record.timestamp.seconds * 1000).toLocaleString('es-ES') : 'N/A'
                }));

                // Crear libro de Excel
                const wb = XLSX.utils.book_new();

                // Hoja de registros individuales
                if (individualExcelData.length > 0) {
                    const wsIndividual = XLSX.utils.json_to_sheet(individualExcelData);
                    const colWidthsIndividual = [
                        { wch: 12 }, { wch: 25 }, { wch: 15 }, { wch: 12 }, 
                        { wch: 20 }, { wch: 30 }, { wch: 20 }, { wch: 20 }
                    ];
                    wsIndividual['!cols'] = colWidthsIndividual;
                    XLSX.utils.book_append_sheet(wb, wsIndividual, 'Asistencia Individual');
                }

                // Hoja de registros por aula
                if (classroomExcelData.length > 0) {
                    const wsClassroom = XLSX.utils.json_to_sheet(classroomExcelData);
                    const colWidthsClassroom = [
                        { wch: 12 }, { wch: 10 }, { wch: 10 }, { wch: 15 }, { wch: 15 }, 
                        { wch: 15 }, { wch: 15 }, { wch: 15 }, { wch: 20 }, { wch: 30 }, 
                        { wch: 20 }, { wch: 20 }
                    ];
                    wsClassroom['!cols'] = colWidthsClassroom;
                    XLSX.utils.book_append_sheet(wb, wsClassroom, 'Asistencia por Aula');
                }

                // Generar nombre de archivo
                const fileName = `Reporte_Firebase_${currentUser.school_name || 'Escuela'}_${startDate}_${endDate}.xlsx`;

                // Descargar archivo
                XLSX.writeFile(wb, fileName);

                showLoading('report-loading', false);
                showSuccess('report-success', `üìä Reporte de Firebase generado: ${fileName}`);

            } catch (error) {
                showLoading('report-loading', false);
                showError('report-error', `‚ùå Error generando reporte: ${error.message}`);
            }
        }

        async function updateFirebaseReportSummary() {
            const startDate = document.getElementById('report-start-date').value;
            const endDate = document.getElementById('report-end-date').value;

            if (!startDate || !endDate || !currentUser || !currentUser.school_id) return;

            try {
                const [individualResult, classroomResult] = await Promise.all([
                    attendanceService.getAttendanceByDate(currentUser.school_id, startDate, endDate, 'individual'),
                    attendanceService.getAttendanceByDate(currentUser.school_id, startDate, endDate, 'classroom')
                ]);

                if (!individualResult.success || !classroomResult.success) return;

                const individualRecords = individualResult.data;
                const classroomRecords = classroomResult.data;

                // Resumen individual
                const individualSummary = {
                    total: individualRecords.length,
                    presente: individualRecords.filter(r => r.status === 'presente').length,
                    ausente: individualRecords.filter(r => r.status === 'ausente').length,
                    tardanza: individualRecords.filter(r => r.status === 'tardanza').length,
                    justificado: individualRecords.filter(r => r.status === 'justificado').length
                };

                // Resumen por aula
                const classroomSummary = {
                    totalAulas: classroomRecords.length,
                    totalVarones: classroomRecords.reduce((sum, r) => sum + (r.male_present || 0), 0),
                    totalMujeres: classroomRecords.reduce((sum, r) => sum + (r.female_present || 0), 0),
                    totalAusentes: classroomRecords.reduce((sum, r) => sum + (r.total_absent || 0), 0),
                    totalMatriculados: classroomRecords.reduce((sum, r) => sum + (r.total_enrolled || 0), 0)
                };

                const summaryContainer = document.getElementById('report-summary');
                summaryContainer.innerHTML = `
                    <div style="background: #f7fafc; padding: 15px; border-radius: 8px; margin-top: 15px;">
                        <h4 style="margin: 0 0 15px 0; color: #2d3748;">üìä Resumen desde Firebase</h4>
                        
                        ${individualRecords.length > 0 ? `
                        <div style="margin-bottom: 20px;">
                            <h5 style="margin: 0 0 10px 0; color: #4a5568;">üë§ Asistencia Individual</h5>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 8px;">
                                <div style="text-align: center; padding: 8px; background: white; border-radius: 6px;">
                                    <div style="font-size: 18px; font-weight: bold; color: #2d3748;">${individualSummary.total}</div>
                                    <div style="font-size: 11px; color: #4a5568;">Total</div>
                                </div>
                                <div style="text-align: center; padding: 8px; background: #c6f6d5; border-radius: 6px;">
                                    <div style="font-size: 18px; font-weight: bold; color: #22543d;">${individualSummary.presente}</div>
                                    <div style="font-size: 11px; color: #22543d;">Presentes</div>
                                </div>
                                <div style="text-align: center; padding: 8px; background: #fed7d7; border-radius: 6px;">
                                    <div style="font-size: 18px; font-weight: bold; color: #742a2a;">${individualSummary.ausente}</div>
                                    <div style="font-size: 11px; color: #742a2a;">Ausentes</div>
                                </div>
                                <div style="text-align: center; padding: 8px; background: #feebc8; border-radius: 6px;">
                                    <div style="font-size: 18px; font-weight: bold; color: #7b341e;">${individualSummary.tardanza}</div>
                                    <div style="font-size: 11px; color: #7b341e;">Tardanzas</div>
                                </div>
                            </div>
                        </div>
                        ` : ''}
                        
                        ${classroomRecords.length > 0 ? `
                        <div>
                            <h5 style="margin: 0 0 10px 0; color: #4a5568;">üè´ Asistencia por Aula</h5>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 8px;">
                                <div style="text-align: center; padding: 8px; background: white; border-radius: 6px;">
                                    <div style="font-size: 18px; font-weight: bold; color: #2d3748;">${classroomSummary.totalAulas}</div>
                                    <div style="font-size: 11px; color: #4a5568;">Aulas</div>
                                </div>
                                <div style="text-align: center; padding: 8px; background: #bee3f8; border-radius: 6px;">
                                    <div style="font-size: 18px; font-weight: bold; color: #2a4365;">${classroomSummary.totalVarones}</div>
                                    <div style="font-size: 11px; color: #2a4365;">üë¶ Varones</div>
                                </div>
                                <div style="text-align: center; padding: 8px; background: #fbb6ce; border-radius: 6px;">
                                    <div style="font-size: 18px; font-weight: bold; color: #97266d;">${classroomSummary.totalMujeres}</div>
                                    <div style="font-size: 11px; color: #97266d;">üëß Mujeres</div>
                                </div>
                                <div style="text-align: center; padding: 8px; background: #fed7d7; border-radius: 6px;">
                                    <div style="font-size: 18px; font-weight: bold; color: #742a2a;">${classroomSummary.totalAusentes}</div>
                                    <div style="font-size: 11px; color: #742a2a;">‚ùå Ausentes</div>
                                </div>
                                <div style="text-align: center; padding: 8px; background: #c6f6d5; border-radius: 6px;">
                                    <div style="font-size: 18px; font-weight: bold; color: #22543d;">${classroomSummary.totalVarones + classroomSummary.totalMujeres}</div>
                                    <div style="font-size: 11px; color: #22543d;">‚úÖ Presentes</div>
                                </div>
                            </div>
                        </div>
                        ` : ''}
                        
                        ${individualRecords.length === 0 && classroomRecords.length === 0 ? '<p style="text-align: center; color: #4a5568; margin: 0;">üì≠ No hay registros en Firebase para el per√≠odo seleccionado</p>' : ''}
                    </div>
                `;
            } catch (error) {
                console.error('Error updating report summary:', error);
            }
        }

        async function loadAllFirebaseRecords() {
            if (!currentUser || !currentUser.school_id || currentUser.role !== 'director') return;

            const container = document.getElementById('all-records');
            container.innerHTML = '<p style="text-align: center; color: #4a5568; padding: 20px;">üîÑ Cargando registros desde Firebase...</p>';

            try {
                const result = await attendanceService.getAttendanceByDate(
                    currentUser.school_id, 
                    '2020-01-01', 
                    '2030-12-31', 
                    'individual'
                );

                if (!result.success) {
                    container.innerHTML = '<p style="text-align: center; color: #f56565; padding: 20px;">‚ùå Error cargando registros de Firebase</p>';
                    return;
                }

                const records = result.data;

                if (records.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #4a5568; padding: 20px;">üì≠ No hay registros disponibles en Firebase</p>';
                    return;
                }

                // Agrupar por estudiante
                const studentGroups = {};
                records.forEach(record => {
                    if (!studentGroups[record.student_id]) {
                        studentGroups[record.student_id] = {
                            name: record.student_name,
                            records: []
                        };
                    }
                    studentGroups[record.student_id].records.push(record);
                });

                container.innerHTML = Object.entries(studentGroups).map(([studentId, data]) => `
                    <div style="background: #f7fafc; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                        <h4 style="margin: 0 0 10px 0; color: #2d3748;">üë§ ${data.name} (ID: ${studentId})</h4>
                        <div style="font-size: 12px; color: #4a5568;">üìä Total de registros en Firebase: ${data.records.length}</div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 8px; margin-top: 10px;">
                            ${data.records.slice(-5).map(record => `
                                <div style="background: white; padding: 8px; border-radius: 4px; font-size: 11px;">
                                    <div><strong>üìÖ ${record.date}</strong></div>
                                    <div class="status-badge status-${record.status}" style="margin-top: 4px; display: inline-block;">
                                        ${getStatusText(record.status)}
                                    </div>
                                    <div style="font-size: 9px; color: #718096; margin-top: 2px;">üî• ${record.id}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `).join('');

            } catch (error) {
                console.error('Error loading all records:', error);
                container.innerHTML = '<p style="text-align: center; color: #f56565; padding: 20px;">‚ùå Error cargando registros de Firebase</p>';
            }
        }

        function getStatusText(status) {
            const statusMap = {
                presente: 'Presente',
                ausente: 'Ausente',
                tardanza: 'Tardanza',
                justificado: 'Justificado'
            };
            return statusMap[status] || status;
        }

        function showLoading(elementId, show) {
            const element = document.getElementById(elementId);
            if (element) {
                element.style.display = show ? 'block' : 'none';
            }
        }

        function showError(elementId, message) {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = message;
                element.style.display = 'block';
                setTimeout(() => {
                    element.style.display = 'none';
                }, 8000);
            }
        }

        function showSuccess(elementId, message) {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = message;
                element.style.display = 'block';
                setTimeout(() => {
                    element.style.display = 'none';
                }, 5000);
            } else {
                console.warn(`Elemento ${elementId} no encontrado para mostrar √©xito:`, message);
            }
        }

        // Funci√≥n para probar Firebase manualmente
        async function testFirebaseManually() {
            const debugInfo = document.getElementById('debug-info');
            debugInfo.innerHTML = 'üîÑ Probando conexi√≥n...';

            try {
                // Verificar que Firebase est√© disponible
                if (!window.firebaseDb) {
                    throw new Error('window.firebaseDb no est√° disponible');
                }
                if (!window.firebaseModules) {
                    throw new Error('window.firebaseModules no est√° disponible');
                }

                // Intentar crear un documento de prueba
                const testData = {
                    test: true,
                    timestamp: new Date().toISOString(),
                    school_id: 'test-school',
                    message: 'Prueba manual de conexi√≥n'
                };

                console.log('üß™ Creando documento de prueba:', testData);

                const docRef = await window.firebaseModules.addDoc(
                    window.firebaseModules.collection(window.firebaseDb, 'manual_test'), 
                    testData
                );

                debugInfo.innerHTML = `
                    ‚úÖ <strong>Conexi√≥n exitosa!</strong><br>
                    üìÑ Documento creado: ${docRef.id}<br>
                    üèóÔ∏è Proyecto: base-de-datos-san-ignacio<br>
                    üîó Firebase SDK: Cargado correctamente
                `;

                updateFirebaseStatus('connected', '‚úÖ Firebase funcionando correctamente');

            } catch (error) {
                console.error('‚ùå Error en prueba manual:', error);
                debugInfo.innerHTML = `
                    ‚ùå <strong>Error de conexi√≥n:</strong><br>
                    üö® ${error.message}<br>
                    üîç C√≥digo: ${error.code || 'N/A'}<br>
                    üìä Firebase DB: ${window.firebaseDb ? 'Disponible' : 'No disponible'}<br>
                    üõ†Ô∏è M√≥dulos: ${window.firebaseModules ? 'Disponible' : 'No disponible'}
                `;

                updateFirebaseStatus('error', '‚ùå Error de conexi√≥n a Firebase');
            }
        }

        // Actualizar informaci√≥n de diagn√≥stico al cargar
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                const debugInfo = document.getElementById('debug-info');
                debugInfo.innerHTML = `
                    üìä Firebase DB: ${window.firebaseDb ? '‚úÖ Disponible' : '‚ùå No disponible'}<br>
                    üõ†Ô∏è M√≥dulos: ${window.firebaseModules ? '‚úÖ Disponible' : '‚ùå No disponible'}<br>
                    üèóÔ∏è Proyecto: base-de-datos-san-ignacio<br>
                    üë§ Usuario: ${currentUser ? currentUser.name : 'No configurado'}
                `;
            }, 1000);
        });
    </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'995c4badd0d7c9df',t:'MTc2MTY3NDAzNy4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
